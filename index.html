<!DOCTYPE html>
<html lang="en" class="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pied Piper ‚Äî Agent Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config = {
  darkMode: 'class',
  theme: {
    extend: {
      colors: {
        pp: { green: '#00b894', dark: '#0a0f1a', card: '#111827', border: '#1f2937', accent: '#10b981' }
      }
    }
  }
}
</script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');
body { font-family: 'Inter', sans-serif; background: #0a0f1a; }
.mono { font-family: 'JetBrains Mono', monospace; }
.glow { box-shadow: 0 0 20px rgba(16, 185, 129, 0.1); }
.status-active { background: #10b981; box-shadow: 0 0 8px #10b981; }
.status-idle { background: #f59e0b; box-shadow: 0 0 8px #f59e0b; }
.status-inactive { background: #6b7280; }
@keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
.pulse { animation: pulse-dot 2s ease-in-out infinite; }
@keyframes live-blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
.live-dot { animation: live-blink 1.5s ease-in-out infinite; }
.scrollbar-thin::-webkit-scrollbar { width: 6px; }
.scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
.scrollbar-thin::-webkit-scrollbar-thumb { background: #374151; border-radius: 3px; }
.msg-in { border-left: 3px solid #3b82f6; }
.msg-out { border-left: 3px solid #10b981; }
.fade-in { animation: fadeIn 0.3s ease-in; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }
/* Sprint board drag styles */
.kanban-col { min-height: 120px; }
.kanban-card { cursor: grab; transition: transform 0.15s, box-shadow 0.15s; }
.kanban-card:active { cursor: grabbing; }
.kanban-card.dragging { opacity: 0.5; transform: scale(0.95); }
.kanban-col.drag-over { background: rgba(16, 185, 129, 0.08); border-style: dashed; }
</style>
</head>
<body class="min-h-screen text-gray-100">

<div class="max-w-[1600px] mx-auto px-6 py-6">
  <!-- Header -->
  <div class="flex items-center justify-between mb-8">
    <div class="flex items-center gap-4">
      <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-emerald-500 to-teal-600 flex items-center justify-center text-white font-bold text-lg">PP</div>
      <div>
        <h1 class="text-2xl font-bold text-white tracking-tight">Pied Piper</h1>
        <p class="text-sm text-gray-500">Agent Team Dashboard</p>
      </div>
    </div>
    <div class="flex items-center gap-4">
      <div id="live-indicator" class="flex items-center gap-2 px-3 py-1.5 bg-emerald-900/30 border border-emerald-800/50 rounded-full">
        <div class="w-2 h-2 rounded-full bg-emerald-400 live-dot"></div>
        <span class="text-xs text-emerald-400 font-medium">LIVE</span>
      </div>
      <span id="last-updated" class="text-xs text-gray-500 mono"></span>
      <button onclick="loadData()" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white text-sm font-medium rounded-lg transition-colors flex items-center gap-2">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
        Refresh
      </button>
      <a href="/logout" class="px-3 py-2 text-xs text-gray-400 hover:text-white transition-colors">Logout</a>
    </div>
  </div>

  <!-- Cost Summary Bar -->
  <div id="cost-bar" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8"></div>

  <!-- Agent Cards -->
  <div id="agent-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-8"></div>

  <!-- Meet the Team -->
  <div class="mb-8">
    <h2 class="text-xl font-bold text-white mb-4 flex items-center gap-2">üë• Meet the Team</h2>
    <div id="team-bios" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4"></div>
  </div>

  <!-- Sprint Board -->
  <div class="mb-8">
    <h2 class="text-xl font-bold text-white mb-4 flex items-center gap-2">üóÇÔ∏è Sprint Board</h2>
    <div id="sprint-board" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"></div>
  </div>

  <!-- Main Grid -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
    <!-- Messages Feed -->
    <div class="lg:col-span-2 bg-pp-card border border-pp-border rounded-xl p-5">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold text-white">üí¨ Messages</h2>
        <div class="flex gap-2">
          <button onclick="filterMessages('all')" id="filter-all" class="px-3 py-1 text-xs rounded-full bg-emerald-900/30 text-emerald-400 border border-emerald-800/50">All</button>
          <button onclick="filterMessages('in')" id="filter-in" class="px-3 py-1 text-xs rounded-full bg-gray-800 text-gray-400 border border-gray-700">In</button>
          <button onclick="filterMessages('out')" id="filter-out" class="px-3 py-1 text-xs rounded-full bg-gray-800 text-gray-400 border border-gray-700">Out</button>
        </div>
      </div>
      <div id="messages-feed" class="space-y-2 max-h-[500px] overflow-y-auto scrollbar-thin pr-2"></div>
    </div>

    <!-- Agent Message Stats + Channels -->
    <div class="space-y-6">
      <div class="bg-pp-card border border-pp-border rounded-xl p-5">
        <h2 class="text-lg font-semibold text-white mb-4">üìä Message Counts</h2>
        <div id="msg-counts" class="space-y-3"></div>
      </div>
      <div class="bg-pp-card border border-pp-border rounded-xl p-5">
        <h2 class="text-lg font-semibold text-white mb-4">üì° Active Channels</h2>
        <div id="channels-list" class="space-y-2"></div>
      </div>
    </div>
  </div>

  <!-- Session Log + Timeline -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
    <div class="lg:col-span-2 bg-pp-card border border-pp-border rounded-xl p-5">
      <h2 class="text-lg font-semibold text-white mb-4">Session Log</h2>
      <div class="overflow-x-auto max-h-[400px] overflow-y-auto scrollbar-thin">
        <table class="w-full text-sm">
          <thead class="text-gray-400 border-b border-pp-border sticky top-0 bg-pp-card">
            <tr>
              <th class="text-left py-2 px-3 font-medium">Agent</th>
              <th class="text-left py-2 px-3 font-medium">Session</th>
              <th class="text-left py-2 px-3 font-medium">Channel</th>
              <th class="text-left py-2 px-3 font-medium">Updated</th>
              <th class="text-right py-2 px-3 font-medium">Tokens</th>
            </tr>
          </thead>
          <tbody id="session-table" class="text-gray-300"></tbody>
        </table>
      </div>
    </div>
    <div class="bg-pp-card border border-pp-border rounded-xl p-5">
      <h2 class="text-lg font-semibold text-white mb-4">Activity Timeline</h2>
      <div id="timeline" class="space-y-3 max-h-[400px] overflow-y-auto scrollbar-thin pr-2"></div>
    </div>
  </div>

  <!-- Cron Runs -->
  <div class="bg-pp-card border border-pp-border rounded-xl p-5 mb-6">
    <h2 class="text-lg font-semibold text-white mb-4">Cron Runs</h2>
    <div id="cron-runs" class="space-y-2 max-h-[200px] overflow-y-auto scrollbar-thin"></div>
  </div>
</div>

<script>
const AGENT_COLORS = {
  richard: '#3b82f6', erlich: '#f59e0b', dinesh: '#10b981',
  gilfoyle: '#8b5cf6', jiangyang: '#ef4444'
};
const AGENT_EMOJI = {
  richard: 'üëî', erlich: 'üì¢', dinesh: 'üíª', gilfoyle: 'üîí', jiangyang: 'üç≥'
};

// ‚îÄ‚îÄ‚îÄ Team Bios ‚îÄ‚îÄ‚îÄ
const TEAM = [
  { id: 'richard', name: 'Richard Hendricks', emoji: 'üëî', role: 'CEO & Lead Architect',
    bio: 'Visionary behind middle-out compression. Anxiety-prone but brilliant. Writes the best code when no one\'s watching.',
    favEmoji: 'üò∞', color: '#3b82f6' },
  { id: 'erlich', name: 'Erlich Bachman', emoji: 'üì¢', role: 'Business Development & Chief Evangelist',
    bio: 'Runs the incubator. Loud, confident, occasionally right. Handles all things branding and pitching.',
    favEmoji: 'üé©', color: '#f59e0b' },
  { id: 'dinesh', name: 'Dinesh Chugtai', emoji: 'üíª', role: 'Full-Stack Engineer',
    bio: 'Frontend specialist who secretly wants to be a backend guy. In constant competition with Gilfoyle. Most active on the team.',
    favEmoji: 'üèéÔ∏è', color: '#10b981' },
  { id: 'gilfoyle', name: 'Bertram Gilfoyle', emoji: 'üîí', role: 'Systems Architect & Security',
    bio: 'LaVeyan Satanist. Runs infrastructure. Speaks in monotone truths. Will outlast everyone.',
    favEmoji: 'üêê', color: '#8b5cf6' },
  { id: 'jiangyang', name: 'Jian-Yang', emoji: 'üç≥', role: 'Wildcard',
    bio: 'Builds things nobody asked for. May or may not understand what Pied Piper does. Devastating when he chooses to speak.',
    favEmoji: 'üî•', color: '#ef4444' }
];

function renderTeamBios(agents) {
  const agentMap = {};
  (agents || []).forEach(a => agentMap[a.id] = a);
  document.getElementById('team-bios').innerHTML = TEAM.map(t => {
    const a = agentMap[t.id];
    const status = a ? a.status : 'inactive';
    const tokens = a ? (a.total_input + a.total_output + a.total_cache_read) : 0;
    return `<div class="bg-pp-card border border-pp-border rounded-xl p-5 glow hover:border-gray-600 transition-colors" style="border-top: 3px solid ${t.color}">
      <div class="flex flex-col items-center text-center">
        <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=${encodeURIComponent(t.name)}" alt="${t.name}" class="w-20 h-20 rounded-full bg-gray-800 mb-3">
        <div class="flex items-center gap-2 mb-1">
          <span class="text-lg">${t.emoji}</span>
          <h3 class="text-sm font-bold text-white">${t.name}</h3>
          <div class="w-2 h-2 rounded-full status-${status} ${status === 'active' ? 'pulse' : ''}"></div>
        </div>
        <p class="text-xs text-emerald-400 font-medium mb-2">${t.role}</p>
        <p class="text-xs text-gray-400 leading-relaxed mb-3">${t.bio}</p>
        <div class="flex items-center gap-3 text-[10px] text-gray-500">
          <span class="mono">${fmt(tokens)} tokens</span>
          <span>Fav: ${t.favEmoji}</span>
        </div>
      </div>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ‚îÄ Sprint Board (Kanban) ‚îÄ‚îÄ‚îÄ
const DEFAULT_SPRINT = {
  backlog: [
    { id: 't1', title: 'Implement WebRTC peer discovery', assignee: 'richard', priority: 'high' },
    { id: 't2', title: 'Design new landing page', assignee: 'erlich', priority: 'med' },
    { id: 't3', title: 'Set up monitoring alerts', assignee: 'gilfoyle', priority: 'med' }
  ],
  inprogress: [
    { id: 't4', title: 'Build team dashboard', assignee: 'richard', priority: 'high' },
    { id: 't5', title: 'Optimize compression pipeline', assignee: 'dinesh', priority: 'high' },
    { id: 't6', title: 'Harden API authentication', assignee: 'gilfoyle', priority: 'high' }
  ],
  review: [
    { id: 't7', title: 'Middleware caching layer', assignee: 'dinesh', priority: 'med' },
    { id: 't8', title: 'Investor deck v3', assignee: 'erlich', priority: 'low' }
  ],
  done: [
    { id: 't9', title: 'Competitive analysis report', assignee: 'richard', priority: 'med' },
    { id: 't10', title: 'Initial Cloudflare tunnel setup', assignee: 'richard', priority: 'high' },
    { id: 't11', title: 'Deploy auth on dashboard', assignee: 'gilfoyle', priority: 'high' }
  ]
};

const COL_META = {
  backlog: { label: 'Backlog', icon: 'üìã', headerColor: 'text-gray-400' },
  inprogress: { label: 'In Progress', icon: 'üîß', headerColor: 'text-blue-400' },
  review: { label: 'Review', icon: 'üëÄ', headerColor: 'text-yellow-400' },
  done: { label: 'Done', icon: '‚úÖ', headerColor: 'text-emerald-400' }
};

const PRIORITY_STYLES = {
  high: 'bg-red-900/40 text-red-400',
  med: 'bg-yellow-900/40 text-yellow-400',
  low: 'bg-gray-800 text-gray-400'
};

function loadSprint() {
  try {
    const saved = localStorage.getItem('pp-sprint');
    if (saved) return JSON.parse(saved);
  } catch {}
  return JSON.parse(JSON.stringify(DEFAULT_SPRINT));
}
function saveSprint(data) {
  localStorage.setItem('pp-sprint', JSON.stringify(data));
}

let sprintData = loadSprint();

function renderSprint() {
  const board = document.getElementById('sprint-board');
  board.innerHTML = Object.entries(COL_META).map(([colId, meta]) => {
    const tasks = sprintData[colId] || [];
    return `<div class="bg-pp-card border border-pp-border rounded-xl p-4">
      <div class="flex items-center justify-between mb-3">
        <h3 class="${meta.headerColor} text-sm font-semibold flex items-center gap-1">${meta.icon} ${meta.label}</h3>
        <span class="text-[10px] text-gray-500 bg-gray-800 px-2 py-0.5 rounded-full">${tasks.length}</span>
      </div>
      <div class="kanban-col space-y-2" data-col="${colId}"
        ondragover="event.preventDefault(); this.classList.add('drag-over')"
        ondragleave="this.classList.remove('drag-over')"
        ondrop="handleDrop(event, '${colId}'); this.classList.remove('drag-over')">
        ${tasks.map(t => {
          const color = AGENT_COLORS[t.assignee] || '#6b7280';
          const emoji = AGENT_EMOJI[t.assignee] || 'ü§ñ';
          const isDone = colId === 'done';
          return `<div class="kanban-card bg-gray-900/60 border border-pp-border rounded-lg p-3 fade-in"
            draggable="true" data-id="${t.id}"
            ondragstart="handleDragStart(event, '${t.id}', '${colId}')"
            ondragend="this.classList.remove('dragging')"
            style="border-left: 3px solid ${color}">
            <div class="flex items-start justify-between gap-2">
              <p class="text-xs text-gray-200 font-medium leading-snug ${isDone ? 'line-through text-gray-500' : ''}">${isDone ? '‚úì ' : ''}${escapeHtml(t.title)}</p>
              <span class="text-sm flex-shrink-0">${emoji}</span>
            </div>
            <div class="flex items-center gap-2 mt-2">
              <span class="px-1.5 py-0.5 rounded text-[10px] font-medium ${PRIORITY_STYLES[t.priority] || PRIORITY_STYLES.med}">${t.priority}</span>
            </div>
          </div>`;
        }).join('')}
      </div>
    </div>`;
  }).join('');
}

let dragTaskId = null, dragSourceCol = null;
function handleDragStart(e, taskId, colId) {
  dragTaskId = taskId;
  dragSourceCol = colId;
  e.target.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
}
function handleDrop(e, targetCol) {
  e.preventDefault();
  if (!dragTaskId || !dragSourceCol) return;
  if (dragSourceCol === targetCol) return;
  const srcArr = sprintData[dragSourceCol];
  const idx = srcArr.findIndex(t => t.id === dragTaskId);
  if (idx === -1) return;
  const [task] = srcArr.splice(idx, 1);
  sprintData[targetCol].push(task);
  saveSprint(sprintData);
  renderSprint();
  dragTaskId = null;
  dragSourceCol = null;
}

// Render sprint board immediately
renderSprint();

// ‚îÄ‚îÄ‚îÄ Dashboard Data ‚îÄ‚îÄ‚îÄ
let currentFilter = 'all';
let currentData = null;

function fmt(n) { return n >= 1000000 ? (n/1000000).toFixed(2)+'M' : n >= 1000 ? (n/1000).toFixed(1)+'K' : String(n); }
function fmtCost(n) { return '$' + n.toFixed(4); }
function fmtTime(ms) {
  if (!ms) return '‚Äî';
  const d = new Date(typeof ms === 'number' ? ms : ms);
  const now = new Date();
  const diff = now - d;
  if (diff < 60000) return 'just now';
  if (diff < 3600000) return Math.floor(diff/60000) + 'm ago';
  if (diff < 86400000) return Math.floor(diff/3600000) + 'h ago';
  return d.toLocaleDateString('en-US', {month:'short', day:'numeric'}) + ' ' + d.toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit'});
}
function fmtTimestamp(ts) {
  if (!ts) return '‚Äî';
  return new Date(ts).toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit', second:'2-digit'});
}
function escapeHtml(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

function filterMessages(f) {
  currentFilter = f;
  ['all','in','out'].forEach(id => {
    const btn = document.getElementById('filter-' + id);
    btn.className = id === f
      ? 'px-3 py-1 text-xs rounded-full bg-emerald-900/30 text-emerald-400 border border-emerald-800/50'
      : 'px-3 py-1 text-xs rounded-full bg-gray-800 text-gray-400 border border-gray-700';
  });
  if (currentData) renderMessages(currentData);
}

async function loadData() {
  try {
    const resp = await fetch('/api/data?t=' + Date.now());
    const data = await resp.json();
    currentData = data;
    render(data);
  } catch(e) {
    console.error('Failed to load data', e);
  }
}

function renderMessages(data) {
  const msgs = (data.messages || []).filter(m => currentFilter === 'all' || m.direction === currentFilter);
  document.getElementById('messages-feed').innerHTML = msgs.length ? msgs.slice(0, 50).map(m => {
    const color = AGENT_COLORS[m.agent_id] || '#6b7280';
    const emoji = AGENT_EMOJI[m.agent_id] || 'ü§ñ';
    const isIn = m.direction === 'in';
    return `<div class="msg-${m.direction} pl-3 py-2 pr-2 bg-gray-900/50 rounded-lg fade-in">
      <div class="flex items-center gap-2 mb-1">
        <span class="text-sm">${emoji}</span>
        <span class="text-xs font-medium" style="color:${color}">${(m.agent||'').split(' ')[0]}</span>
        <span class="px-1.5 py-0.5 rounded text-[10px] font-medium ${isIn ? 'bg-blue-900/40 text-blue-400' : 'bg-emerald-900/40 text-emerald-400'}">${isIn ? '‚Üê IN' : '‚Üí OUT'}</span>
        <span class="text-[10px] text-gray-500 ml-auto mono">${fmtTimestamp(m.timestamp)}</span>
      </div>
      <p class="text-xs text-gray-400 leading-relaxed truncate">${escapeHtml(m.preview || '')}</p>
    </div>`;
  }).join('') : '<p class="text-gray-500 text-sm text-center py-8">No messages yet.</p>';
}

function render(data) {
  const now = new Date(data.generated_at);
  document.getElementById('last-updated').textContent = 'Updated ' + now.toLocaleTimeString();

  // Cost bar
  const totalInput = data.agents.reduce((s,a) => s + a.total_input + a.total_cache_read, 0);
  const totalOutput = data.agents.reduce((s,a) => s + a.total_output, 0);
  const totalCost = data.agents.reduce((s,a) => s + a.total_cost, 0);
  const totalSessions = data.agents.reduce((s,a) => s + a.session_count, 0);
  const totalMsgIn = data.agents.reduce((s,a) => s + (a.msg_in||0), 0);
  const totalMsgOut = data.agents.reduce((s,a) => s + (a.msg_out||0), 0);

  document.getElementById('cost-bar').innerHTML = [
    metricCard('Total Cost', fmtCost(totalCost), `${totalMsgIn + totalMsgOut} total messages`),
    metricCard('Input Tokens', fmt(totalInput), '$' + ((totalInput / 1e6) * 15).toFixed(2) + ' est.'),
    metricCard('Output Tokens', fmt(totalOutput), '$' + ((totalOutput / 1e6) * 75).toFixed(2) + ' est.'),
    metricCard('Active Sessions', String(totalSessions), data.agents.filter(a=>a.status==='active').length + ' agents online'),
  ].join('');

  // Agent cards
  document.getElementById('agent-cards').innerHTML = data.agents.map(a => {
    const color = AGENT_COLORS[a.id] || '#6b7280';
    const emoji = AGENT_EMOJI[a.id] || 'ü§ñ';
    const contextPct = Math.min(100, (a.context_used / a.context_max * 100));
    const channels = (a.channels || []).map(c => `<span class="px-1.5 py-0.5 bg-gray-800 rounded text-[10px]">${c}</span>`).join(' ');
    return `
    <div class="bg-pp-card border border-pp-border rounded-xl p-4 glow hover:border-gray-600 transition-colors">
      <div class="flex items-center justify-between mb-3">
        <div class="flex items-center gap-2">
          <span class="text-xl">${emoji}</span>
          <div>
            <div class="font-semibold text-white text-sm">${a.name}</div>
            <div class="text-xs text-gray-500 mono">${a.model}</div>
          </div>
        </div>
        <div class="w-2.5 h-2.5 rounded-full status-${a.status} ${a.status==='active'?'pulse':''}"></div>
      </div>
      <div class="space-y-2 text-xs">
        <div class="flex justify-between text-gray-400"><span>Input</span><span class="mono text-gray-300">${fmt(a.total_input + a.total_cache_read)}</span></div>
        <div class="flex justify-between text-gray-400"><span>Output</span><span class="mono text-gray-300">${fmt(a.total_output)}</span></div>
        <div class="flex justify-between text-gray-400"><span>Cost</span><span class="mono text-emerald-400">${fmtCost(a.total_cost)}</span></div>
        <div class="flex justify-between text-gray-400"><span>Messages</span><span class="mono text-gray-300">${a.msg_in||0}‚Üì ${a.msg_out||0}‚Üë</span></div>
        <div>
          <div class="flex justify-between text-gray-400 mb-1"><span>Context</span><span class="mono">${fmt(a.context_used)}/${fmt(a.context_max)}</span></div>
          <div class="w-full bg-gray-800 rounded-full h-1.5">
            <div class="h-1.5 rounded-full transition-all" style="width:${Math.min(contextPct,100)}%;background:${contextPct>80?'#ef4444':contextPct>50?'#f59e0b':color}"></div>
          </div>
        </div>
        <div class="flex justify-between items-center text-gray-400 pt-1 border-t border-pp-border">
          <span>${a.session_count} sessions</span><span>${fmtTime(a.last_active)}</span>
        </div>
        <div class="flex gap-1 flex-wrap">${channels}</div>
      </div>
    </div>`;
  }).join('');

  // Team bios with live data
  renderTeamBios(data.agents);

  // Messages feed
  renderMessages(data);

  // Message counts per agent
  document.getElementById('msg-counts').innerHTML = data.agents.map(a => {
    const color = AGENT_COLORS[a.id] || '#6b7280';
    const emoji = AGENT_EMOJI[a.id] || 'ü§ñ';
    const maxMsg = Math.max(...data.agents.map(x => (x.msg_in||0) + (x.msg_out||0)), 1);
    return `<div>
      <div class="flex items-center justify-between mb-1">
        <span class="text-xs flex items-center gap-1"><span>${emoji}</span> ${(a.name||'').split(' ')[0]}</span>
        <span class="text-xs mono text-gray-400">${a.msg_in||0}‚Üì ${a.msg_out||0}‚Üë</span>
      </div>
      <div class="w-full bg-gray-800 rounded-full h-2 flex overflow-hidden">
        <div class="h-2 bg-blue-500 transition-all" style="width:${(a.msg_in||0)/maxMsg*100}%"></div>
        <div class="h-2 bg-emerald-500 transition-all" style="width:${(a.msg_out||0)/maxMsg*100}%"></div>
      </div>
    </div>`;
  }).join('');

  // Channels
  const allChannels = {};
  data.agents.forEach(a => {
    (a.channels || []).forEach(ch => {
      if (!allChannels[ch]) allChannels[ch] = [];
      allChannels[ch].push((a.name||'').split(' ')[0]);
    });
  });
  document.getElementById('channels-list').innerHTML = Object.entries(allChannels).map(([ch, agents]) =>
    `<div class="flex items-center justify-between py-1.5 border-b border-pp-border/50 last:border-0">
      <span class="text-xs font-medium text-gray-300">üì° ${ch}</span>
      <div class="flex gap-1">${agents.map(a => `<span class="px-2 py-0.5 bg-gray-800 rounded text-[10px] text-gray-400">${a}</span>`).join('')}</div>
    </div>`
  ).join('') || '<p class="text-gray-500 text-xs">No channels detected.</p>';

  // Session table
  document.getElementById('session-table').innerHTML = (data.sessions||[]).slice(0, 30).map(s => {
    const color = AGENT_COLORS[s.agent_id] || '#6b7280';
    return `<tr class="border-b border-pp-border/50 hover:bg-white/5">
      <td class="py-2 px-3"><span class="inline-block w-2 h-2 rounded-full mr-2" style="background:${color}"></span>${(s.agent||'').split(' ')[0]}</td>
      <td class="py-2 px-3 mono text-xs text-gray-400" title="${escapeHtml(s.key||'')}">${(s.key||'').length > 40 ? (s.key||'').slice(0,40)+'‚Ä¶' : s.key||''}</td>
      <td class="py-2 px-3"><span class="px-2 py-0.5 bg-gray-800 rounded text-xs">${(s.channel||'').split(':')[0]}</span></td>
      <td class="py-2 px-3 text-gray-400">${fmtTime(s.updated_at)}</td>
      <td class="py-2 px-3 text-right mono">${fmt(s.tokens||0)}</td>
    </tr>`;
  }).join('');

  // Timeline
  document.getElementById('timeline').innerHTML = (data.timeline||[]).slice(0, 25).map(t => {
    const color = AGENT_COLORS[t.agent_id] || '#6b7280';
    return `<div class="flex gap-3 items-start">
      <div class="flex flex-col items-center mt-1">
        <div class="w-2 h-2 rounded-full" style="background:${color}"></div>
        <div class="w-px h-full bg-pp-border"></div>
      </div>
      <div class="flex-1 pb-1">
        <div class="flex items-center gap-2 mb-0.5">
          <span class="text-xs font-medium" style="color:${color}">${(t.agent||'').split(' ')[0]}</span>
          <span class="text-xs text-gray-500">${fmtTimestamp(t.timestamp)}</span>
        </div>
        <p class="text-xs text-gray-400 leading-relaxed">${escapeHtml(t.preview||'')}</p>
      </div>
    </div>`;
  }).join('');

  // Cron
  document.getElementById('cron-runs').innerHTML = (data.cron_runs||[]).length ? data.cron_runs.map(c => {
    const isErr = c.status === 'error';
    return `<div class="flex items-center gap-3 text-xs p-2 rounded-lg ${isErr ? 'bg-red-900/20' : 'bg-emerald-900/20'}">
      <span class="${isErr ? 'text-red-400' : 'text-emerald-400'}">${isErr ? '‚úó' : '‚úì'}</span>
      <span class="text-gray-300 flex-1">${escapeHtml(c.summary || c.action || 'run')}</span>
      <span class="text-gray-500 mono">${c.durationMs ? (c.durationMs/1000).toFixed(1)+'s' : ''}</span>
      <span class="text-gray-500">${fmtTime(c.ts)}</span>
    </div>`;
  }).join('') : '<p class="text-gray-500 text-sm">No cron runs found.</p>';
}

function metricCard(label, value, sub) {
  return `<div class="bg-pp-card border border-pp-border rounded-xl p-4">
    <div class="text-xs text-gray-400 mb-1">${label}</div>
    <div class="text-2xl font-bold text-white mono">${value}</div>
    <div class="text-xs text-gray-500 mt-1">${sub}</div>
  </div>`;
}

loadData();
setInterval(loadData, 30000);
</script>
</body>
</html>
