<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pied Piper ‚Äî Agent Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0b0e14;--card:#131720;--card-border:#1e2433;--accent:#22d3ee;
  --accent2:#a78bfa;--accent3:#f472b6;--accent4:#34d399;--accent5:#fb923c;
  --text:#e2e8f0;--text-dim:#64748b;--text-bright:#f8fafc;
  --hover:#1a2030;
}
body{font-family:'Inter',system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
a{color:var(--accent);text-decoration:none}

.header{padding:24px 32px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--card-border)}
.header h1{font-size:22px;font-weight:700;color:var(--text-bright)}
.header h1 span{color:var(--accent);font-weight:800}
.header .meta{font-size:13px;color:var(--text-dim)}
.refresh-dot{display:inline-block;width:8px;height:8px;border-radius:50%;background:#22c55e;margin-right:6px;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

/* Tab bar */
.tab-bar{display:flex;gap:0;border-bottom:1px solid var(--card-border);padding:0 32px;background:var(--card)}
.tab-bar button{background:none;border:none;color:var(--text-dim);font-size:14px;font-weight:600;padding:14px 24px;cursor:pointer;border-bottom:2px solid transparent;transition:all .2s}
.tab-bar button:hover{color:var(--text-bright);background:var(--hover)}
.tab-bar button.active{color:var(--accent);border-bottom-color:var(--accent)}

.container{max-width:1400px;margin:0 auto;padding:24px 32px}
.tab-content{display:none}
.tab-content.active{display:block}

/* Team totals */
.team-totals{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:28px}
.stat-box{background:var(--card);border:1px solid var(--card-border);border-radius:12px;padding:20px 24px}
.stat-box .label{font-size:12px;text-transform:uppercase;letter-spacing:.08em;color:var(--text-dim);margin-bottom:6px}
.stat-box .value{font-size:28px;font-weight:700;color:var(--text-bright)}
.stat-box .value.cost{color:var(--accent)}

/* Agent cards */
.agents-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:16px;margin-bottom:28px}
.agent-card{background:var(--card);border:1px solid var(--card-border);border-radius:12px;padding:20px;position:relative;overflow:hidden;transition:border-color .2s}
.agent-card:hover{border-color:var(--accent)}
.agent-card .name{font-size:16px;font-weight:700;color:var(--text-bright);text-transform:capitalize;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.agent-card .name .dot{width:10px;height:10px;border-radius:50%}
.agent-card .row{display:flex;justify-content:space-between;font-size:13px;padding:4px 0;border-bottom:1px solid #1a1f2e}
.agent-card .row:last-child{border:none}
.agent-card .row .k{color:var(--text-dim)}
.agent-card .row .v{font-weight:600;font-variant-numeric:tabular-nums}

/* Charts */
.charts{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:28px}
.chart-box{background:var(--card);border:1px solid var(--card-border);border-radius:12px;padding:20px}
.chart-box h3{font-size:14px;font-weight:600;color:var(--text-dim);margin-bottom:16px}
.chart-box canvas{width:100%!important;max-height:300px}

/* Activity */
.activity{background:var(--card);border:1px solid var(--card-border);border-radius:12px;padding:20px}
.activity h3{font-size:14px;font-weight:600;color:var(--text-dim);margin-bottom:16px}
.activity-item{padding:10px 0;border-bottom:1px solid #1a1f2e;display:flex;gap:12px;font-size:13px}
.activity-item:last-child{border:none}
.activity-item .agent-tag{font-weight:700;text-transform:capitalize;min-width:80px;flex-shrink:0}
.activity-item .role-tag{font-size:11px;padding:2px 8px;border-radius:4px;font-weight:600;flex-shrink:0}
.role-user{background:#1e3a5f;color:#60a5fa}
.role-assistant{background:#1a3d2e;color:#34d399}
.activity-item .time{color:var(--text-dim);min-width:140px;flex-shrink:0;font-variant-numeric:tabular-nums}
.activity-item .preview{color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

/* ===== Team Bios ===== */
.team-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:20px}
.bio-card{background:var(--card);border:1px solid var(--card-border);border-radius:14px;padding:24px;transition:border-color .2s,transform .2s}
.bio-card:hover{border-color:var(--accent);transform:translateY(-2px)}
.bio-card .bio-header{display:flex;align-items:center;gap:16px;margin-bottom:16px}
.bio-card .avatar{width:64px;height:64px;border-radius:50%;border:2px solid var(--card-border);flex-shrink:0}
.bio-card .bio-name{font-size:18px;font-weight:700;color:var(--text-bright)}
.bio-card .bio-role{font-size:13px;color:var(--text-dim);margin-top:2px}
.bio-card .bio-text{font-size:13px;color:var(--text);line-height:1.6;margin-bottom:16px;font-style:italic}
.bio-card .bio-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.bio-card .bio-stat{text-align:center;background:var(--bg);border-radius:8px;padding:10px 6px}
.bio-card .bio-stat .bs-val{font-size:16px;font-weight:700;color:var(--text-bright)}
.bio-card .bio-stat .bs-label{font-size:10px;text-transform:uppercase;letter-spacing:.06em;color:var(--text-dim);margin-top:2px}

/* ===== Sprint Board ===== */
.sprint-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.sprint-header h2{font-size:20px;font-weight:700;color:var(--text-bright)}
.btn{padding:8px 18px;border-radius:8px;border:none;font-size:13px;font-weight:600;cursor:pointer;transition:all .15s}
.btn-primary{background:var(--accent);color:#0b0e14}
.btn-primary:hover{opacity:.85}
.btn-danger{background:#f85149;color:#fff}
.btn-danger:hover{opacity:.85}
.btn-ghost{background:transparent;color:var(--text-dim);border:1px solid var(--card-border)}
.btn-ghost:hover{border-color:var(--text-dim);color:var(--text)}

.kanban{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;min-height:400px}
.kanban-col{background:var(--card);border:1px solid var(--card-border);border-radius:12px;padding:16px;min-height:300px}
.kanban-col.drag-over{border-color:var(--accent);background:#131a24}
.kanban-col-title{font-size:13px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--text-dim);margin-bottom:14px;display:flex;align-items:center;gap:8px}
.kanban-col-title .count{background:var(--bg);padding:2px 8px;border-radius:10px;font-size:11px}
.task-card{background:var(--bg);border:1px solid var(--card-border);border-radius:10px;padding:14px;margin-bottom:10px;cursor:grab;transition:all .15s;border-left:3px solid transparent}
.task-card:active{cursor:grabbing}
.task-card:hover{border-color:var(--accent)}
.task-card.dragging{opacity:.4;transform:scale(.95)}
.task-card .tc-title{font-size:14px;font-weight:600;color:var(--text-bright);margin-bottom:6px}
.task-card .tc-desc{font-size:12px;color:var(--text-dim);margin-bottom:10px;line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.task-card .tc-footer{display:flex;justify-content:space-between;align-items:center;font-size:11px;color:var(--text-dim)}
.task-card .tc-assignee{display:flex;align-items:center;gap:6px;font-weight:600}
.task-card .tc-assignee img{width:20px;height:20px;border-radius:50%}
.task-card .tc-actions{display:flex;gap:4px;opacity:0;transition:opacity .15s}
.task-card:hover .tc-actions{opacity:1}
.tc-actions button{background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:14px;padding:2px 4px;border-radius:4px}
.tc-actions button:hover{color:var(--accent);background:var(--card)}
.tc-actions button.delete:hover{color:#f85149}

/* Modal */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:100;align-items:center;justify-content:center}
.modal-overlay.show{display:flex}
.modal{background:var(--card);border:1px solid var(--card-border);border-radius:14px;padding:28px;width:440px;max-width:90vw}
.modal h3{font-size:18px;font-weight:700;color:var(--text-bright);margin-bottom:20px}
.modal label{display:block;font-size:12px;font-weight:600;color:var(--text-dim);text-transform:uppercase;letter-spacing:.06em;margin-bottom:6px;margin-top:14px}
.modal input,.modal textarea,.modal select{width:100%;background:var(--bg);border:1px solid var(--card-border);border-radius:8px;padding:10px 12px;color:var(--text);font-size:14px;font-family:inherit}
.modal input:focus,.modal textarea:focus,.modal select:focus{outline:none;border-color:var(--accent)}
.modal textarea{resize:vertical;min-height:60px}
.modal select option{background:var(--bg);color:var(--text)}
.modal-buttons{display:flex;gap:10px;margin-top:20px;justify-content:flex-end}

@media(max-width:900px){
  .team-totals{grid-template-columns:repeat(2,1fr)}
  .charts{grid-template-columns:1fr}
  .kanban{grid-template-columns:1fr}
  .team-grid{grid-template-columns:1fr}
}
</style>
</head>
<body>
<div class="header">
  <h1>üî• <span>Pied Piper</span> Agent Dashboard</h1>
  <div class="meta"><span class="refresh-dot"></span>Auto-refresh 30s ¬∑ <span id="lastUpdate">‚Äî</span> ¬∑ <a href="/logout" style="color:#f85149;font-size:12px;margin-left:12px">Logout</a></div>
</div>

<div class="tab-bar">
  <button class="active" onclick="switchTab('dashboard')">üìä Dashboard</button>
  <button onclick="switchTab('team')">üë• Team</button>
  <button onclick="switchTab('sprint')">üèÉ Sprint Board</button>
</div>

<div class="container">
  <!-- Dashboard Tab -->
  <div id="tab-dashboard" class="tab-content active">
    <div class="team-totals" id="teamTotals"></div>
    <div class="agents-grid" id="agentsGrid"></div>
    <div class="charts">
      <div class="chart-box"><h3>üí∞ Cost per Agent</h3><canvas id="costChart"></canvas></div>
      <div class="chart-box"><h3>üìä Token Usage Over Time</h3><canvas id="tokenChart"></canvas></div>
    </div>
    <div class="activity" id="activitySection">
      <h3>‚ö° Recent Activity</h3>
      <div id="activityList"></div>
    </div>
  </div>

  <!-- Team Tab -->
  <div id="tab-team" class="tab-content">
    <div class="team-grid" id="teamGrid"></div>
  </div>

  <!-- Sprint Board Tab -->
  <div id="tab-sprint" class="tab-content">
    <div class="sprint-header">
      <h2>üèÉ Sprint Board</h2>
      <button class="btn btn-primary" onclick="openTaskModal()">+ New Task</button>
    </div>
    <div class="kanban">
      <div class="kanban-col" data-status="backlog" ondragover="onDragOver(event)" ondragleave="onDragLeave(event)" ondrop="onDrop(event)">
        <div class="kanban-col-title">üìã Backlog <span class="count" id="count-backlog">0</span></div>
        <div id="col-backlog"></div>
      </div>
      <div class="kanban-col" data-status="in-progress" ondragover="onDragOver(event)" ondragleave="onDragLeave(event)" ondrop="onDrop(event)">
        <div class="kanban-col-title">üî® In Progress <span class="count" id="count-in-progress">0</span></div>
        <div id="col-in-progress"></div>
      </div>
      <div class="kanban-col" data-status="done" ondragover="onDragOver(event)" ondragleave="onDragLeave(event)" ondrop="onDrop(event)">
        <div class="kanban-col-title">‚úÖ Done <span class="count" id="count-done">0</span></div>
        <div id="col-done"></div>
      </div>
    </div>
  </div>
</div>

<!-- Task Modal -->
<div class="modal-overlay" id="taskModal">
  <div class="modal">
    <h3 id="modalTitle">New Task</h3>
    <input type="hidden" id="taskId">
    <label>Title</label>
    <input type="text" id="taskTitleInput" placeholder="What needs to be done?">
    <label>Description</label>
    <textarea id="taskDescInput" placeholder="Details..."></textarea>
    <label>Assignee</label>
    <select id="taskAssigneeInput">
      <option value="richard">üò∞ Richard</option>
      <option value="erlich">üï∂Ô∏è Erlich</option>
      <option value="dinesh">üíª Dinesh</option>
      <option value="gilfoyle">üñ§ Gilfoyle</option>
      <option value="jiangyang">ü§´ Jian-Yang</option>
    </select>
    <label>Status</label>
    <select id="taskStatusInput">
      <option value="backlog">Backlog</option>
      <option value="in-progress">In Progress</option>
      <option value="done">Done</option>
    </select>
    <div class="modal-buttons">
      <button class="btn btn-ghost" onclick="closeTaskModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveTask()">Save</button>
    </div>
  </div>
</div>

<script>
const COLORS = {'richard':'#22d3ee','erlich':'#a78bfa','dinesh':'#f472b6','gilfoyle':'#34d399','jiangyang':'#fb923c'};
const TEAM_DATA = [
  {key:'richard',name:'Richard Hendricks',role:'CEO / Lead Architect',emoji:'üò∞',bio:'Founder of Pied Piper. Invented middle-out compression. Tries to keep everyone focused while quietly panicking.'},
  {key:'erlich',name:'Erlich Bachman',role:'Business / Strategy',emoji:'üï∂Ô∏è',bio:'Business visionary. Runs the incubator. Will pitch anything to anyone. Believes in Pied Piper more than anyone (especially himself).'},
  {key:'dinesh',name:'Dinesh Chugtai',role:'Frontend / Full-Stack Engineer',emoji:'üíª',bio:'Full-stack engineer. Ships features fast. Perpetually locked in rivalry with Gilfoyle. Owns a gold chain.'},
  {key:'gilfoyle',name:'Gilfoyle',role:'Security / Infrastructure',emoji:'üñ§',bio:'Systems architect and security lead. LaVeyan Satanist. Will remind you that everything you built is wrong.'},
  {key:'jiangyang',name:'Jian-Yang',role:'Wildcard',emoji:'ü§´',bio:'Does... something. Nobody is entirely sure what. Occasionally devastating.'},
];
const DISPLAY_NAMES = {'richard':'Richard','erlich':'Erlich','dinesh':'Dinesh','gilfoyle':'Gilfoyle','jiangyang':'Jian-Yang'};

let costChart, tokenChart, cachedAgentStats = {};

function fmt(n){return n>=1e6?(n/1e6).toFixed(1)+'M':n>=1e3?(n/1e3).toFixed(1)+'K':n.toString()}
function fmtCost(n){return '$'+n.toFixed(4)}
function timeAgo(ts){
  if(!ts)return '‚Äî';
  const d=new Date(ts),now=new Date(),s=Math.floor((now-d)/1000);
  if(s<60)return s+'s ago';if(s<3600)return Math.floor(s/60)+'m ago';
  if(s<86400)return Math.floor(s/3600)+'h ago';return Math.floor(s/86400)+'d ago';
}
function shortTime(ts){if(!ts)return '';return new Date(ts).toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:true})}
function escHtml(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}
function avatarUrl(name){return `https://api.dicebear.com/7.x/bottts/svg?seed=${encodeURIComponent(name)}`}
function shortDate(ts){if(!ts)return '';return new Date(ts).toLocaleDateString('en-US',{month:'short',day:'numeric'})}

// --- Tab switching ---
function switchTab(tab){
  document.querySelectorAll('.tab-content').forEach(el=>el.classList.remove('active'));
  document.querySelectorAll('.tab-bar button').forEach(el=>el.classList.remove('active'));
  document.getElementById('tab-'+tab).classList.add('active');
  document.querySelectorAll('.tab-bar button').forEach(el=>{if(el.textContent.toLowerCase().includes(tab==='sprint'?'sprint':tab))el.classList.add('active')});
  if(tab==='sprint')loadSprints();
}

// --- Dashboard ---
async function refresh(){
  const [statsRes, actRes] = await Promise.all([fetch('/api/stats'),fetch('/api/activity')]);
  const stats = await statsRes.json();
  const act = await actRes.json();
  
  // Cache stats for team page
  stats.agents.forEach(a=>{cachedAgentStats[a.agent]=a});

  const t=stats.team;
  document.getElementById('teamTotals').innerHTML=`
    <div class="stat-box"><div class="label">Total Cost</div><div class="value cost">${fmtCost(t.totalCost)}</div></div>
    <div class="stat-box"><div class="label">Total Tokens</div><div class="value">${fmt(t.totalTokens)}</div></div>
    <div class="stat-box"><div class="label">Total Messages</div><div class="value">${fmt(t.totalMessages)}</div></div>
    <div class="stat-box"><div class="label">Assistant Turns</div><div class="value">${fmt(t.assistantMessages)}</div></div>`;

  document.getElementById('agentsGrid').innerHTML=stats.agents.map(a=>`
    <div class="agent-card">
      <div class="name"><span class="dot" style="background:${COLORS[a.agent]}"></span>${a.agent}</div>
      <div class="row"><span class="k">Messages</span><span class="v">${a.totalMessages}</span></div>
      <div class="row"><span class="k">Tokens In</span><span class="v">${fmt(a.tokensInput)}</span></div>
      <div class="row"><span class="k">Tokens Out</span><span class="v">${fmt(a.tokensOutput)}</span></div>
      <div class="row"><span class="k">Cache Read</span><span class="v">${fmt(a.tokensCacheRead)}</span></div>
      <div class="row"><span class="k">Total Cost</span><span class="v" style="color:var(--accent)">${fmtCost(a.totalCost)}</span></div>
      <div class="row"><span class="k">Model</span><span class="v">${a.models.join(', ')||'‚Äî'}</span></div>
      <div class="row"><span class="k">Last Active</span><span class="v">${timeAgo(a.lastActive)}</span></div>
    </div>`).join('');

  const costData={labels:stats.agents.map(a=>a.agent),datasets:[{data:stats.agents.map(a=>a.totalCost),backgroundColor:stats.agents.map(a=>COLORS[a.agent]),borderWidth:0,borderRadius:6}]};
  if(costChart)costChart.destroy();
  costChart=new Chart(document.getElementById('costChart'),{type:'bar',data:costData,options:{responsive:true,plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#64748b'},grid:{color:'#1e2433'}},y:{ticks:{color:'#64748b',callback:v=>'$'+v.toFixed(2)},grid:{color:'#1e2433'}}}}});

  const allBuckets=new Set();
  stats.agents.forEach(a=>Object.keys(a.timeSeries).forEach(k=>allBuckets.add(k)));
  const sortedBuckets=[...allBuckets].sort();
  const labels=sortedBuckets.map(b=>{const d=new Date(b+':00:00Z');return d.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:true})});
  const datasets=stats.agents.map(a=>({label:a.agent,data:sortedBuckets.map(b=>(a.timeSeries[b]||{}).tokens||0),borderColor:COLORS[a.agent],backgroundColor:COLORS[a.agent]+'33',tension:.3,fill:true,pointRadius:3}));
  if(tokenChart)tokenChart.destroy();
  tokenChart=new Chart(document.getElementById('tokenChart'),{type:'line',data:{labels,datasets},options:{responsive:true,interaction:{intersect:false,mode:'index'},plugins:{legend:{labels:{color:'#94a3b8',usePointStyle:true,pointStyle:'circle'}}},scales:{x:{ticks:{color:'#64748b'},grid:{color:'#1e2433'}},y:{ticks:{color:'#64748b',callback:v=>fmt(v)},grid:{color:'#1e2433'}}}}});

  document.getElementById('activityList').innerHTML=act.activity.map(a=>`
    <div class="activity-item">
      <span class="agent-tag" style="color:${COLORS[a.agent]}">${a.agent}</span>
      <span class="role-tag role-${a.role}">${a.role}</span>
      <span class="time">${shortTime(a.timestamp)}</span>
      <span class="preview">${escHtml(a.content_preview||'')}</span>
    </div>`).join('')||'<div style="color:var(--text-dim);padding:12px">No activity yet</div>';

  document.getElementById('lastUpdate').textContent=new Date().toLocaleTimeString();
  renderTeam();
}

// --- Team Bios ---
function renderTeam(){
  document.getElementById('teamGrid').innerHTML=TEAM_DATA.map(m=>{
    const s=cachedAgentStats[m.key]||{};
    return `<div class="bio-card" style="border-left:3px solid ${COLORS[m.key]}">
      <div class="bio-header">
        <img class="avatar" src="${avatarUrl(m.name)}" alt="${m.name}">
        <div><div class="bio-name">${m.emoji} ${m.name}</div><div class="bio-role">${m.role}</div></div>
      </div>
      <div class="bio-text">"${m.bio}"</div>
      <div class="bio-stats">
        <div class="bio-stat"><div class="bs-val">${s.totalMessages||0}</div><div class="bs-label">Messages</div></div>
        <div class="bio-stat"><div class="bs-val">${fmtCost(s.totalCost||0)}</div><div class="bs-label">Cost</div></div>
        <div class="bio-stat"><div class="bs-val">${timeAgo(s.lastActive)}</div><div class="bs-label">Last Active</div></div>
      </div>
    </div>`}).join('');
}

// --- Sprint Board ---
let sprintTasks = [];
async function loadSprints(){
  const res=await fetch('/api/sprints');
  const data=await res.json();
  sprintTasks=data.tasks;
  renderSprints();
}
function renderSprints(){
  const cols={backlog:[],['in-progress']:[],done:[]};
  sprintTasks.forEach(t=>{if(cols[t.status])cols[t.status].push(t)});
  ['backlog','in-progress','done'].forEach(status=>{
    document.getElementById('count-'+status).textContent=cols[status].length;
    document.getElementById('col-'+status).innerHTML=cols[status].map(t=>`
      <div class="task-card" draggable="true" data-id="${t.id}" style="border-left-color:${COLORS[t.assignee]||'var(--accent)'}"
           ondragstart="onDragStart(event)" ondragend="onDragEnd(event)">
        <div class="tc-title">${escHtml(t.title)}</div>
        <div class="tc-desc">${escHtml(t.description||'')}</div>
        <div class="tc-footer">
          <span class="tc-assignee"><img src="${avatarUrl(DISPLAY_NAMES[t.assignee]||t.assignee)}" alt="">${DISPLAY_NAMES[t.assignee]||t.assignee}</span>
          <span>${shortDate(t.created)}</span>
        </div>
        <div class="tc-actions">
          <button onclick="editTask(${t.id})" title="Edit">‚úèÔ∏è</button>
          <button class="delete" onclick="deleteTask(${t.id})" title="Delete">üóëÔ∏è</button>
        </div>
      </div>`).join('');
  });
}

// Drag & drop
let dragId=null;
function onDragStart(e){dragId=e.target.dataset.id;e.target.classList.add('dragging');e.dataTransfer.effectAllowed='move'}
function onDragEnd(e){e.target.classList.remove('dragging');dragId=null}
function onDragOver(e){e.preventDefault();e.currentTarget.classList.add('drag-over')}
function onDragLeave(e){e.currentTarget.classList.remove('drag-over')}
async function onDrop(e){
  e.preventDefault();e.currentTarget.classList.remove('drag-over');
  if(!dragId)return;
  const newStatus=e.currentTarget.dataset.status;
  await fetch('/api/sprints/'+dragId,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({status:newStatus})});
  loadSprints();
}

// Modal
function openTaskModal(task){
  document.getElementById('modalTitle').textContent=task?'Edit Task':'New Task';
  document.getElementById('taskId').value=task?task.id:'';
  document.getElementById('taskTitleInput').value=task?task.title:'';
  document.getElementById('taskDescInput').value=task?task.description:'';
  document.getElementById('taskAssigneeInput').value=task?task.assignee:'richard';
  document.getElementById('taskStatusInput').value=task?task.status:'backlog';
  document.getElementById('taskModal').classList.add('show');
}
function closeTaskModal(){document.getElementById('taskModal').classList.remove('show')}
function editTask(id){const t=sprintTasks.find(t=>t.id===id);if(t)openTaskModal(t)}
async function deleteTask(id){
  if(!confirm('Delete this task?'))return;
  await fetch('/api/sprints/'+id,{method:'DELETE'});
  loadSprints();
}
async function saveTask(){
  const id=document.getElementById('taskId').value;
  const body={
    title:document.getElementById('taskTitleInput').value,
    description:document.getElementById('taskDescInput').value,
    assignee:document.getElementById('taskAssigneeInput').value,
    status:document.getElementById('taskStatusInput').value,
  };
  if(id){await fetch('/api/sprints/'+id,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)})}
  else{await fetch('/api/sprints',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)})}
  closeTaskModal();
  loadSprints();
}

// Close modal on overlay click
document.getElementById('taskModal').addEventListener('click',e=>{if(e.target===e.currentTarget)closeTaskModal()});

refresh();
setInterval(refresh,30000);
</script>
</body>
</html>
