<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pied Piper ‚Äî Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',system-ui,sans-serif;background:#111;color:#eee;min-height:100vh}
a{color:#10b981;text-decoration:none}

/* Layout */
.shell{display:flex;min-height:100vh}

/* Sidebar */
.sidebar{
  width:220px;background:#161616;border-right:1px solid #222;
  display:flex;flex-direction:column;position:fixed;top:0;bottom:0;z-index:50;
}
.sidebar-brand{padding:20px 20px 16px;font-size:14px;font-weight:600;display:flex;align-items:center;gap:8px;color:#fff;border-bottom:1px solid #222}
.sidebar-brand .dot{width:8px;height:8px;border-radius:50%;background:#10b981}
.sidebar-nav{padding:12px 8px;flex:1}
.nav-item{
  display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:8px;
  font-size:13px;font-weight:500;color:#777;cursor:pointer;transition:all .12s;margin-bottom:2px;
}
.nav-item:hover{background:#1e1e1e;color:#ccc}
.nav-item.active{background:#1e1e1e;color:#fff}
.nav-item .icon{font-size:16px;width:20px;text-align:center}
.sidebar-footer{padding:16px 20px;border-top:1px solid #222;font-size:12px}
.sidebar-footer a{color:#555;transition:color .15s}
.sidebar-footer a:hover{color:#ef4444}

/* Main */
.main{margin-left:220px;flex:1;min-width:0}
.topbar{
  padding:16px 32px;border-bottom:1px solid #222;display:flex;align-items:center;justify-content:space-between;
  position:sticky;top:0;background:#111;z-index:40;
}
.topbar h2{font-size:16px;font-weight:600;color:#fff}
.topbar .meta{font-size:12px;color:#555;display:flex;align-items:center;gap:8px}
.topbar .live{width:6px;height:6px;border-radius:50%;background:#10b981;animation:blink 2s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}

.page{padding:28px 32px;max-width:100%}
.page-section{display:none}
.page-section.active{display:block}

/* Metrics row */
.metrics{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px}
.metrics2{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:28px}
.metric .sub{font-size:11px;color:#555;margin-top:4px}
.metric .val.blue{color:#38bdf8}
.metric .val.purple{color:#a78bfa}
.metric{background:#1a1a1a;border:1px solid #222;border-radius:10px;padding:18px 20px}
.metric .label{font-size:11px;font-weight:500;color:#555;text-transform:uppercase;letter-spacing:.06em;margin-bottom:6px}
.metric .val{font-size:26px;font-weight:700;color:#fff;letter-spacing:-.02em;font-variant-numeric:tabular-nums}
.metric .val.green{color:#10b981}

/* Agent row */
.agents{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-bottom:28px}
.agent{background:#1a1a1a;border:1px solid #222;border-radius:10px;padding:16px;transition:border-color .15s;cursor:default}
.agent:hover{border-color:#333}
.agent-head{display:flex;align-items:center;gap:8px;margin-bottom:12px}
.agent-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.agent-name{font-size:13px;font-weight:600;color:#fff;text-transform:capitalize}
.agent-row{display:flex;justify-content:space-between;font-size:11px;padding:3px 0;color:#666}
.agent-row .v{color:#aaa;font-weight:500;font-variant-numeric:tabular-nums}

/* Charts */
.charts-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:28px}
.chart-card{background:#1a1a1a;border:1px solid #222;border-radius:10px;padding:18px 20px}
.chart-card h3{font-size:12px;font-weight:600;color:#555;margin-bottom:14px;text-transform:uppercase;letter-spacing:.04em}
.chart-card canvas{max-height:220px}

/* Activity feed */
.feed{background:#1a1a1a;border:1px solid #222;border-radius:10px;overflow:hidden}
.feed-header{padding:14px 20px;font-size:12px;font-weight:600;color:#555;text-transform:uppercase;letter-spacing:.04em;border-bottom:1px solid #222}
.feed-item{display:flex;align-items:center;gap:12px;padding:10px 20px;border-bottom:1px solid #1e1e1e;font-size:12px;transition:background .1s}
.feed-item:last-child{border:none}
.feed-item:hover{background:#1e1e1e}
.feed-agent{font-weight:600;min-width:72px;text-transform:capitalize}
.feed-badge{font-size:10px;padding:2px 8px;border-radius:4px;font-weight:600;text-transform:uppercase}
.feed-badge.user{background:#1e293b;color:#60a5fa}
.feed-badge.assistant{background:#14332a;color:#34d399}
.feed-time{color:#444;min-width:70px;font-variant-numeric:tabular-nums;font-size:11px}
.feed-text{color:#888;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;min-width:0}

/* Team page */
.team-cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}
.tcard{background:#1a1a1a;border:1px solid #222;border-radius:12px;padding:24px;transition:border-color .15s}
.tcard:hover{border-color:#333}
.tcard-top{display:flex;align-items:center;gap:14px;margin-bottom:16px}
.tcard-photo{width:56px;height:56px;border-radius:50%;object-fit:cover;background:#222;border:2px solid #333}
.tcard-info .tname{font-size:16px;font-weight:600;color:#fff}
.tcard-info .trole{font-size:12px;color:#555;margin-top:2px}
.tcard-bio{font-size:12px;color:#777;line-height:1.6;margin-bottom:16px;font-style:italic}
.tcard-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.tcard-stat{text-align:center;background:#161616;border-radius:8px;padding:10px 4px}
.tcard-stat .sv{font-size:15px;font-weight:700;color:#fff}
.tcard-stat .sl{font-size:9px;color:#555;text-transform:uppercase;letter-spacing:.06em;margin-top:3px}

/* Sprint board */
.sprint-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.sprint-top h2{font-size:18px;font-weight:700;color:#fff}
.board{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.col{background:#1a1a1a;border:1px solid #222;border-radius:10px;padding:14px;min-height:300px}
.col.drag-over{border-color:#10b981;background:#141e1a}
.col-head{font-size:11px;font-weight:600;color:#555;text-transform:uppercase;letter-spacing:.08em;margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid #222;display:flex;justify-content:space-between}
.col-head .cnt{color:#444;font-weight:500}
.tsk{
  background:#161616;border:1px solid #222;border-radius:8px;padding:12px;margin-bottom:8px;
  cursor:grab;transition:all .12s;border-left:3px solid transparent;
}
.tsk:hover{border-color:#333}
.tsk:active{cursor:grabbing}
.tsk.dragging{opacity:.3}
.tsk-title{font-size:13px;font-weight:600;color:#fff;margin-bottom:4px}
.tsk-desc{font-size:11px;color:#555;margin-bottom:8px;line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.tsk-foot{display:flex;justify-content:space-between;align-items:center;font-size:11px;color:#444}
.tsk-foot .assignee{font-weight:500;color:#888}
.tsk-actions{display:flex;gap:2px;opacity:0;transition:opacity .12s}
.tsk:hover .tsk-actions{opacity:1}
.tsk-actions button{background:none;border:none;color:#555;cursor:pointer;font-size:12px;padding:2px 4px;border-radius:4px}
.tsk-actions button:hover{color:#10b981;background:#1e1e1e}
.tsk-actions button.del:hover{color:#ef4444}

/* Buttons */
.btn{padding:8px 16px;border-radius:8px;border:none;font-size:13px;font-weight:500;cursor:pointer;font-family:inherit;transition:all .12s}
.btn-w{background:#fff;color:#111}
.btn-w:hover{opacity:.9}
.btn-r{background:#ef4444;color:#fff}
.btn-r:hover{opacity:.9}
.btn-o{background:transparent;color:#666;border:1px solid #333}
.btn-o:hover{color:#ccc;border-color:#555}

/* Modal */
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:100;align-items:center;justify-content:center}
.overlay.show{display:flex}
.modal{background:#1a1a1a;border:1px solid #333;border-radius:14px;padding:28px;width:420px;max-width:90vw}
.modal h3{font-size:16px;font-weight:600;color:#fff;margin-bottom:20px}
.modal label{display:block;font-size:11px;font-weight:500;color:#555;text-transform:uppercase;letter-spacing:.06em;margin-bottom:5px;margin-top:14px}
.modal input,.modal textarea,.modal select{
  width:100%;padding:10px 12px;background:#161616;border:1px solid #333;border-radius:8px;
  color:#eee;font-size:13px;font-family:inherit;outline:none;transition:border-color .15s;
}
.modal input:focus,.modal textarea:focus,.modal select:focus{border-color:#10b981}
.modal textarea{resize:vertical;min-height:60px}
.modal select option{background:#1a1a1a}
.modal-btns{display:flex;gap:8px;margin-top:20px;justify-content:flex-end}

/* Drive */
.drive-bar{display:flex;gap:12px;align-items:center;margin-bottom:20px}
.drive-search{
  flex:1;max-width:300px;padding:9px 14px;background:#1a1a1a;border:1px solid #222;border-radius:8px;
  color:#eee;font-size:13px;font-family:inherit;outline:none;transition:border-color .15s;
}
.drive-search:focus{border-color:#10b981}
.drive-search::placeholder{color:#444}
.drive-metrics{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px}
.dtable{background:#1a1a1a;border:1px solid #222;border-radius:10px;overflow:hidden}
.dtable table{width:100%;border-collapse:collapse}
.dtable th{text-align:left;padding:12px 20px;font-size:11px;font-weight:600;color:#444;text-transform:uppercase;letter-spacing:.06em;background:#161616;border-bottom:1px solid #222}
.dtable th:last-child{text-align:right}
.dtable td{padding:12px 20px;border-bottom:1px solid #1e1e1e;font-size:13px}
.dtable tr:hover td{background:#1e1e1e}
.dtable .fname{color:#fff;font-weight:500;display:flex;align-items:center;gap:8px}
.dtable .fmeta{color:#555;font-size:12px}
.dtable .factions{text-align:right;white-space:nowrap}
.empty{text-align:center;padding:48px 20px;color:#444;font-size:13px}
.empty .eicon{font-size:36px;margin-bottom:12px;opacity:.4}

@media(max-width:900px){
  .sidebar{display:none}
  .main{margin-left:0}
  .metrics,.agents{grid-template-columns:repeat(2,1fr)}
  .charts-row,.board{grid-template-columns:1fr}
  .page{padding:20px 16px}
}
@media(max-width:600px){
  .metrics,.agents,.drive-metrics{grid-template-columns:1fr}
}
</style>
</head>
<body>
<div class="shell">
  <!-- Sidebar -->
  <nav class="sidebar">
    <div class="sidebar-brand"><span class="dot"></span>Pied Piper</div>
    <div class="sidebar-nav">
      <div class="nav-item active" onclick="go('dashboard')"><span class="icon">üìä</span>Dashboard</div>
      <div class="nav-item" onclick="go('team')"><span class="icon">üë•</span>Team</div>
      <div class="nav-item" onclick="go('sprint')"><span class="icon">üìã</span>Sprint Board</div>
      <div class="nav-item" onclick="go('goals')"><span class="icon">üéØ</span>Goals</div>
      <div class="nav-item" onclick="go('leaderboard')"><span class="icon">üèÜ</span>Leaderboard</div>
      <div class="nav-item" onclick="go('messages')"><span class="icon">üí¨</span>Messages</div>
      <div class="nav-item" onclick="go('drive')"><span class="icon">üìÅ</span>Shared Drive</div>
      <div class="nav-item" onclick="go('code')"><span class="icon">üíª</span>Code</div>
      <div class="nav-item" onclick="go('docs')"><span class="icon">üìñ</span>Docs</div>
    </div>
    <div class="sidebar-footer"><a href="/logout">Sign out</a></div>
  </nav>

  <!-- Main content -->
  <div class="main">
    <div class="topbar">
      <h2 id="pageTitle">Dashboard</h2>
      <div class="meta"><span class="live"></span>Live ¬∑ <span id="lastUpdate">‚Äî</span></div>
    </div>
    <div class="page">

      <!-- Dashboard -->
      <div id="sec-dashboard" class="page-section active">
        <div class="metrics" id="metrics"></div>
        <div class="agents" id="agents"></div>
        <div class="charts-row">
          <div class="chart-card"><h3>Cost by Agent</h3><canvas id="costChart"></canvas></div>
          <div class="chart-card"><h3>Tokens Over Time</h3><canvas id="tokenChart"></canvas></div>
        </div>
        <div class="feed">
          <div class="feed-header">Recent Activity</div>
          <div id="feedList"></div>
        </div>
      </div>

      <!-- Team -->
      <div id="sec-team" class="page-section">
        <div class="team-cards" id="teamCards"></div>
      </div>

      <!-- Sprint -->
      <div id="sec-sprint" class="page-section">
        <div class="sprint-top">
          <h2>Sprint Board</h2>
          <button class="btn btn-w" onclick="openModal()">+ New Task</button>
        </div>
        <div class="board">
          <div class="col" data-status="backlog" ondragover="dragOver(event)" ondragleave="dragLeave(event)" ondrop="drop(event)">
            <div class="col-head">Backlog <span class="cnt" id="cnt-backlog">0</span></div>
            <div id="col-backlog"></div>
          </div>
          <div class="col" data-status="in-progress" ondragover="dragOver(event)" ondragleave="dragLeave(event)" ondrop="drop(event)">
            <div class="col-head">In Progress <span class="cnt" id="cnt-in-progress">0</span></div>
            <div id="col-in-progress"></div>
          </div>
          <div class="col" data-status="blocked" ondragover="dragOver(event)" ondragleave="dragLeave(event)" ondrop="drop(event)">
            <div class="col-head">Blocked <span class="cnt" id="cnt-blocked">0</span></div>
            <div id="col-blocked"></div>
          </div>
          <div class="col" data-status="done" ondragover="dragOver(event)" ondragleave="dragLeave(event)" ondrop="drop(event)">
            <div class="col-head">Done <span class="cnt" id="cnt-done">0</span></div>
            <div id="col-done"></div>
          </div>
        </div>
      </div>

      <!-- Goals -->
      <div id="sec-goals" class="page-section">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px">
          <h2 style="font-size:18px;font-weight:700;color:#fff;margin:0">üéØ Goals & Milestones</h2>
          <button class="btn btn-w" onclick="openGoalModal()">+ New Goal</button>
        </div>
        <div id="goalsList"></div>
      </div>

      <!-- Leaderboard -->
      <div id="sec-leaderboard" class="page-section">
        <h2 style="font-size:18px;font-weight:700;color:#fff;margin-bottom:24px">üèÜ Agent Leaderboard</h2>
        <div id="lbContent"></div>
      </div>

      <!-- Messages -->
      <div id="sec-messages" class="page-section">
        <div style="display:flex;gap:12px;align-items:center;margin-bottom:20px;flex-wrap:wrap">
          <select id="msgAgent" onchange="loadMsgs()" style="padding:9px 14px;background:#1a1a1a;border:1px solid #222;border-radius:8px;color:#eee;font-size:13px;font-family:inherit;outline:none">
            <option value="">All Agents</option>
            <option value="richard">Richard</option>
            <option value="erlich">Erlich</option>
            <option value="dinesh">Dinesh</option>
            <option value="gilfoyle">Gilfoyle</option>
            <option value="jiangyang">Jian-Yang</option>
          </select>
          <select id="msgRole" onchange="loadMsgs()" style="padding:9px 14px;background:#1a1a1a;border:1px solid #222;border-radius:8px;color:#eee;font-size:13px;font-family:inherit;outline:none">
            <option value="">All Roles</option>
            <option value="user">User (Inbound)</option>
            <option value="assistant">Assistant (Outbound)</option>
          </select>
          <input id="msgSearch" placeholder="Search messages..." oninput="filterMsgs()" style="flex:1;max-width:300px;padding:9px 14px;background:#1a1a1a;border:1px solid #222;border-radius:8px;color:#eee;font-size:13px;font-family:inherit;outline:none">
        </div>
        <div id="msgList" class="feed" style="max-height:calc(100vh - 220px);overflow-y:auto"></div>
      </div>

      <!-- Code -->
      <div id="sec-code" class="page-section">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
          <div style="display:flex;gap:12px;align-items:center;flex:1">
            <input id="codeSearch" placeholder="Search repos..." oninput="filterRepos()" style="flex:1;max-width:300px;padding:9px 14px;background:#1a1a1a;border:1px solid #222;border-radius:8px;color:#eee;font-size:13px;font-family:inherit;outline:none">
            <select id="codeLang" onchange="filterRepos()" style="padding:9px 14px;background:#1a1a1a;border:1px solid #222;border-radius:8px;color:#eee;font-size:13px;font-family:inherit;outline:none">
              <option value="">All Languages</option>
            </select>
          </div>
        </div>
        <div class="drive-metrics">
          <div class="metric"><div class="label">Repositories</div><div class="val" id="repoCount">0</div></div>
          <div class="metric"><div class="label">Languages</div><div class="val" id="repoLangs">0</div></div>
          <div class="metric"><div class="label">Last Push</div><div class="val" id="repoLastPush" style="font-size:16px">‚Äî</div></div>
        </div>
        <div id="repoGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:12px"></div>
      </div>

      <!-- Commit Viewer Modal -->
      <div class="overlay" id="commitModal" onclick="if(event.target===this)closeCommits()">
        <div class="modal" style="width:640px;max-height:85vh;overflow-y:auto">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
            <h3 id="commitTitle" style="margin:0">Recent Commits</h3>
            <button class="btn btn-o" onclick="closeCommits()" style="font-size:12px;padding:6px 14px">‚úï</button>
          </div>
          <div id="commitList"></div>
        </div>
      </div>

      <!-- Docs -->
      <div id="sec-docs" class="page-section">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
          <div style="display:flex;gap:12px;align-items:center;flex:1">
            <select id="docCatFilter" onchange="filterDocs()" style="padding:9px 14px;background:#1a1a1a;border:1px solid #222;border-radius:8px;color:#eee;font-size:13px;font-family:inherit;outline:none">
              <option value="">All Categories</option>
              <option value="onboarding">üöÄ Onboarding</option>
              <option value="tutorial">üìö Tutorial</option>
              <option value="runbook">üîß Runbook</option>
              <option value="architecture">üèóÔ∏è Architecture</option>
              <option value="process">üìã Process</option>
              <option value="general">üìÑ General</option>
            </select>
            <select id="docAudienceFilter" onchange="filterDocs()" style="padding:9px 14px;background:#1a1a1a;border:1px solid #222;border-radius:8px;color:#eee;font-size:13px;font-family:inherit;outline:none">
              <option value="">All Audiences</option>
              <option value="human">üßë Human</option>
              <option value="ai">ü§ñ AI Agent</option>
              <option value="all">üë• Everyone</option>
            </select>
            <input id="docSearch" placeholder="Search docs..." oninput="filterDocs()" style="flex:1;max-width:300px;padding:9px 14px;background:#1a1a1a;border:1px solid #222;border-radius:8px;color:#eee;font-size:13px;font-family:inherit;outline:none">
          </div>
          <button class="btn btn-w" onclick="openDocModal()">+ New Doc</button>
        </div>
        <div class="drive-metrics">
          <div class="metric"><div class="label">Total Docs</div><div class="val" id="docCount">0</div></div>
          <div class="metric"><div class="label">Categories</div><div class="val" id="docCats">0</div></div>
          <div class="metric"><div class="label">Last Updated</div><div class="val" id="docLastUpdate" style="font-size:16px">‚Äî</div></div>
        </div>
        <div id="docsGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:12px"></div>
      </div>

      <!-- Doc Editor Modal -->
      <div class="overlay" id="docModal" onclick="if(event.target===this)closeDocModal()">
        <div class="modal" style="width:700px;max-height:90vh;overflow-y:auto">
          <h3 id="docModalTitle">New Doc</h3>
          <input type="hidden" id="docId">
          <label>Title</label>
          <input id="docTitleIn" placeholder="e.g. How to Deploy, New Agent Onboarding">
          <label>Category</label>
          <select id="docCategoryIn">
            <option value="onboarding">üöÄ Onboarding</option>
            <option value="tutorial">üìö Tutorial</option>
            <option value="runbook">üîß Runbook</option>
            <option value="architecture">üèóÔ∏è Architecture</option>
            <option value="process">üìã Process</option>
            <option value="general">üìÑ General</option>
          </select>
          <label>Audience</label>
          <select id="docAudienceIn">
            <option value="all">üë• Everyone</option>
            <option value="human">üßë Human Team Member</option>
            <option value="ai">ü§ñ AI Agent</option>
          </select>
          <label>Author</label>
          <select id="docAuthorIn">
            <option value="richard">Richard</option>
            <option value="erlich">Erlich</option>
            <option value="dinesh">Dinesh</option>
            <option value="gilfoyle">Gilfoyle</option>
            <option value="jiangyang">Jian-Yang</option>
          </select>
          <label>Tags (comma-separated)</label>
          <input id="docTagsIn" placeholder="e.g. setup, deploy, flask, agents">
          <label>Content (Markdown supported)</label>
          <textarea id="docContentIn" placeholder="Write your doc here... Markdown is supported." style="min-height:250px;font-family:'SF Mono',Monaco,Consolas,monospace;font-size:12px;line-height:1.6"></textarea>
          <div class="modal-btns">
            <button class="btn btn-o" onclick="closeDocModal()">Cancel</button>
            <button class="btn btn-w" onclick="saveDoc()">Save</button>
          </div>
        </div>
      </div>

      <!-- Doc Viewer Modal -->
      <div class="overlay" id="docViewer" onclick="if(event.target===this)closeDocViewer()">
        <div style="background:#1a1a1a;border:1px solid #333;border-radius:14px;width:90vw;max-width:900px;height:85vh;display:flex;flex-direction:column;overflow:hidden">
          <div style="display:flex;justify-content:space-between;align-items:center;padding:16px 24px;border-bottom:1px solid #222;flex-shrink:0">
            <div style="min-width:0">
              <div id="dvTitle" style="font-size:16px;font-weight:700;color:#fff"></div>
              <div id="dvMeta" style="font-size:11px;color:#555;margin-top:4px"></div>
            </div>
            <div style="display:flex;gap:8px;flex-shrink:0">
              <button class="btn btn-o" style="font-size:12px;padding:6px 14px" onclick="editDocFromViewer()">‚úèÔ∏è Edit</button>
              <button class="btn btn-o" onclick="closeDocViewer()" style="font-size:12px;padding:6px 14px">‚úï Close</button>
            </div>
          </div>
          <div id="dvContent" style="flex:1;overflow:auto;padding:28px 32px;color:#ccc;font-size:14px;line-height:1.8"></div>
        </div>
      </div>

      <!-- Drive -->
      <div id="sec-drive" class="page-section">
        <div class="drive-bar">
          <input class="drive-search" id="driveQ" placeholder="Search files..." oninput="filterFiles()">
          <label class="btn btn-w" style="cursor:pointer">
            Upload
            <input type="file" id="driveInput" multiple style="display:none" onchange="uploadFiles()">
          </label>
        </div>
        <div class="drive-metrics">
          <div class="metric"><div class="label">Files</div><div class="val" id="dCount">0</div></div>
          <div class="metric"><div class="label">Storage</div><div class="val" id="dSize">0 B</div></div>
          <div class="metric"><div class="label">Last Upload</div><div class="val" id="dLast" style="font-size:16px">‚Äî</div></div>
        </div>
        <div class="dtable">
          <table>
            <thead><tr><th>Name</th><th>Size</th><th>Uploaded</th><th>Actions</th></tr></thead>
            <tbody id="dBody"><tr><td colspan="4"><div class="empty"><div class="eicon">üìÇ</div>No files yet</div></td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Goal Modal -->
<div class="overlay" id="goalModal" onclick="if(event.target===this)closeGoalModal()">
  <div class="modal">
    <h3 id="goalModalTitle">New Goal</h3>
    <input type="hidden" id="goalId">
    <label>Title</label>
    <input id="goalTitleIn" placeholder="e.g. Ship v2, Close Series B">
    <label>Description</label>
    <textarea id="goalDescIn" placeholder="What does success look like?"></textarea>
    <label>Owner</label>
    <select id="goalOwnerIn">
      <option value="richard">Richard</option>
      <option value="erlich">Erlich</option>
      <option value="dinesh">Dinesh</option>
      <option value="gilfoyle">Gilfoyle</option>
      <option value="jiangyang">Jian-Yang</option>
    </select>
    <label>Deadline</label>
    <input type="date" id="goalDeadlineIn" style="color-scheme:dark">
    <div class="modal-btns">
      <button class="btn btn-o" onclick="closeGoalModal()">Cancel</button>
      <button class="btn btn-w" onclick="saveGoal()">Save</button>
    </div>
  </div>
</div>

<!-- Comments Modal -->
<div class="overlay" id="commentModal" onclick="if(event.target===this)closeComments()">
  <div class="modal" style="width:560px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <h3 id="commentTitle" style="margin:0">Comments</h3>
      <span id="commentAssignee" style="font-size:12px;color:#555"></span>
    </div>
    <input type="hidden" id="commentTaskId">
    <div id="commentList" style="max-height:350px;overflow-y:auto;margin-bottom:16px"></div>
    <div style="display:flex;gap:8px">
      <input id="commentInput" placeholder="Leave a comment..." style="flex:1;padding:10px 12px;background:#161616;border:1px solid #333;border-radius:8px;color:#eee;font-size:13px;font-family:inherit;outline:none">
      <button class="btn btn-w" onclick="addComment()">Send</button>
    </div>
  </div>
</div>

<!-- Work Log Modal -->
<div class="overlay" id="logModal" onclick="if(event.target===this)closeLog()">
  <div class="modal" style="width:520px">
    <h3 id="logTitle">Work Log</h3>
    <input type="hidden" id="logTaskId">
    <div id="logEntries" style="max-height:300px;overflow-y:auto;margin-bottom:16px"></div>
    <div style="display:flex;gap:8px">
      <input id="logInput" placeholder="What did you work on?" style="flex:1;padding:10px 12px;background:#161616;border:1px solid #333;border-radius:8px;color:#eee;font-size:13px;font-family:inherit;outline:none">
      <button class="btn btn-w" onclick="addLogEntry()">Add</button>
    </div>
  </div>
</div>

<!-- File Viewer -->
<div class="overlay" id="viewer" onclick="if(event.target===this)closeViewer()">
  <div style="background:#1a1a1a;border:1px solid #333;border-radius:14px;width:90vw;max-width:1100px;height:85vh;display:flex;flex-direction:column;overflow:hidden">
    <div style="display:flex;justify-content:space-between;align-items:center;padding:16px 24px;border-bottom:1px solid #222;flex-shrink:0">
      <div style="display:flex;align-items:center;gap:12px;min-width:0">
        <span id="vIcon" style="font-size:20px"></span>
        <span id="vName" style="font-size:14px;font-weight:600;color:#fff;overflow:hidden;text-overflow:ellipsis;white-space:nowrap"></span>
        <span id="vSize" style="font-size:12px;color:#555"></span>
      </div>
      <div style="display:flex;gap:8px;flex-shrink:0">
        <a id="vDownload" class="btn btn-o" style="font-size:12px;padding:6px 14px;text-decoration:none">Download</a>
        <button class="btn btn-o" onclick="closeViewer()" style="font-size:12px;padding:6px 14px">‚úï Close</button>
      </div>
    </div>
    <div id="vContent" style="flex:1;overflow:auto;display:flex;align-items:center;justify-content:center;background:#111;position:relative"></div>
  </div>
</div>

<!-- Modal -->
<div class="overlay" id="modal">
  <div class="modal">
    <h3 id="mTitle">New Task</h3>
    <input type="hidden" id="mId">
    <label>Title</label>
    <input id="mTitleIn" placeholder="What needs to be done?">
    <label>Description</label>
    <textarea id="mDescIn" placeholder="Details..."></textarea>
    <label>Assignee</label>
    <select id="mAssignIn">
      <option value="richard">Richard</option>
      <option value="erlich">Erlich</option>
      <option value="dinesh">Dinesh</option>
      <option value="gilfoyle">Gilfoyle</option>
      <option value="jiangyang">Jian-Yang</option>
    </select>
    <label>Status</label>
    <select id="mStatusIn">
      <option value="backlog">Backlog</option>
      <option value="in-progress">In Progress</option>
      <option value="blocked">Blocked</option>
      <option value="done">Done</option>
    </select>
    <label>Linked Goal</label>
    <select id="mGoalIn">
      <option value="">None</option>
    </select>
    <div class="modal-btns">
      <button class="btn btn-o" onclick="closeModal()">Cancel</button>
      <button class="btn btn-w" onclick="saveTask()">Save</button>
    </div>
  </div>
</div>

<script>
const C={'richard':'#38bdf8','erlich':'#a78bfa','dinesh':'#f472b6','gilfoyle':'#10b981','jiangyang':'#fb923c'};
const NAMES={'richard':'Richard','erlich':'Erlich','dinesh':'Dinesh','gilfoyle':'Gilfoyle','jiangyang':'Jian-Yang'};
const TEAM=[
  {k:'richard',name:'Richard Hendricks',role:'CEO / Lead Architect',bio:'Founder of Pied Piper. Invented middle-out compression. Tries to keep everyone focused while quietly panicking.',photo:'/static/img/richard.jpg'},
  {k:'erlich',name:'Erlich Bachman',role:'Business / Strategy',bio:'Business visionary. Runs the incubator. Will pitch anything to anyone. Believes in Pied Piper more than anyone (especially himself).',photo:'/static/img/erlich.jpg'},
  {k:'dinesh',name:'Dinesh Chugtai',role:'Frontend / Full-Stack',bio:'Full-stack engineer. Ships features fast. Perpetually locked in rivalry with Gilfoyle. Owns a gold chain.',photo:'/static/img/dinesh.jpg'},
  {k:'gilfoyle',name:'Gilfoyle',role:'Security / Infra',bio:'Systems architect and security lead. LaVeyan Satanist. Will remind you that everything you built is wrong.',photo:'/static/img/gilfoyle.jpg'},
  {k:'jiangyang',name:'Jian-Yang',role:'Wildcard',bio:'Does... something. Nobody is entirely sure what. Occasionally devastating.',photo:'/static/img/jianyang.jpg'},
];

let costChart,tokenChart,agentCache={},tasks=[];

const fmt=n=>n>=1e6?(n/1e6).toFixed(1)+'M':n>=1e3?(n/1e3).toFixed(1)+'K':n.toString();
const $=n=>n.toFixed(4);
const ago=ts=>{if(!ts)return'‚Äî';const s=Math.floor((Date.now()-new Date(ts))/1000);if(s<0)return'now';if(s<60)return s+'s';if(s<3600)return Math.floor(s/60)+'m';if(s<86400)return Math.floor(s/3600)+'h';return Math.floor(s/86400)+'d'};
const hm=ts=>ts?new Date(ts).toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:true}):'';
const esc=s=>s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
const sd=ts=>ts?new Date(ts).toLocaleDateString('en-US',{month:'short',day:'numeric'}):'';
const fb=b=>{if(!b)return'0 B';const u=['B','KB','MB','GB'];const i=Math.floor(Math.log(b)/Math.log(1024));return(b/Math.pow(1024,i)).toFixed(i?1:0)+' '+u[i]};

const TITLES={dashboard:'Dashboard',team:'Team',sprint:'Sprint Board',goals:'Goals & Milestones',leaderboard:'Agent Leaderboard',messages:'Messages',code:'Code',drive:'Shared Drive',docs:'Docs'};
function go(p){
  document.querySelectorAll('.page-section').forEach(e=>e.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
  document.getElementById('sec-'+p).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(e=>{if(e.textContent.trim().toLowerCase().includes(p==='sprint'?'sprint':p==='drive'?'drive':p))e.classList.add('active')});
  document.getElementById('pageTitle').textContent=TITLES[p]||p;
  if(p==='sprint')loadTasks();
  if(p==='goals')loadGoals();
  if(p==='leaderboard')loadLeaderboard();
  if(p==='messages')loadMsgs();
  if(p==='drive')loadFiles();
  if(p==='code')loadRepos();
  if(p==='docs')loadDocs();
}

async function refresh(){
  try{
    const[sr,ar]=await Promise.all([fetch('/api/stats'),fetch('/api/activity')]);
    const s=await sr.json(),a=await ar.json();
    s.agents.forEach(x=>{agentCache[x.agent]=x});
    const t=s.team;

    const humanRate=65;// $/hr for equivalent human work
    const hoursSaved=t.totalHumanEquivHours||0;
    const moneySaved=Math.round(hoursSaved*humanRate);
    const roi=t.totalCost>0?Math.round(moneySaved/t.totalCost):0;

    document.getElementById('metrics').innerHTML=`
      <div class="metric"><div class="label">‚è±Ô∏è Agent Active Hours</div><div class="val blue">${t.totalActiveHours||0}h</div><div class="sub">Hours with at least 1 agent working</div></div>
      <div class="metric"><div class="label">üßë‚Äçüíª Human-Equiv Hours Saved</div><div class="val purple">${hoursSaved}h</div><div class="sub">Based on output tokens vs human typing speed</div></div>
      <div class="metric"><div class="label">üí∞ Estimated $ Saved</div><div class="val green">$${fmt(moneySaved)}</div><div class="sub">At $${humanRate}/hr human equivalent rate</div></div>`;

    // Second row of metrics
    let m2=document.getElementById('metrics2');
    if(!m2){m2=document.createElement('div');m2.id='metrics2';m2.className='metrics2';document.getElementById('metrics').after(m2)}
    m2.innerHTML=`
      <div class="metric"><div class="label">Total Cost</div><div class="val green">$${$(t.totalCost)}</div></div>
      <div class="metric"><div class="label">Messages</div><div class="val">${fmt(t.totalMessages)}</div></div>
      <div class="metric"><div class="label">ROI</div><div class="val" style="color:#10b981">${roi}x</div><div class="sub">$ saved / $ spent on agents</div></div>`;

    document.getElementById('agents').innerHTML=s.agents.map(x=>`
      <div class="agent">
        <div class="agent-head"><span class="agent-dot" style="background:${C[x.agent]}"></span><span class="agent-name">${x.agent}</span></div>
        <div class="agent-row"><span>Active Hours</span><span class="v" style="color:#38bdf8">${x.activeHours||0}h</span></div>
        <div class="agent-row"><span>Hours Saved</span><span class="v" style="color:#a78bfa">${x.humanEquivHours||0}h</span></div>
        <div class="agent-row"><span>Messages</span><span class="v">${x.totalMessages}</span></div>
        <div class="agent-row"><span>Cost</span><span class="v" style="color:${C[x.agent]}">$${$(x.totalCost)}</span></div>
        <div class="agent-row"><span>Last Active</span><span class="v">${ago(x.lastActive)}</span></div>
      </div>`).join('');

    // Cost chart
    if(costChart)costChart.destroy();
    costChart=new Chart(document.getElementById('costChart'),{type:'bar',data:{
      labels:s.agents.map(x=>x.agent),
      datasets:[{data:s.agents.map(x=>x.totalCost),backgroundColor:s.agents.map(x=>C[x.agent]),borderRadius:4,borderSkipped:false}]
    },options:{responsive:true,plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#444'},grid:{display:false}},y:{ticks:{color:'#444',callback:v=>'$'+v.toFixed(2)},grid:{color:'#222'}}}}});

    // Token chart
    const bk=new Set();
    s.agents.forEach(x=>Object.keys(x.timeSeries||{}).forEach(k=>bk.add(k)));
    const sb=[...bk].sort();
    if(tokenChart)tokenChart.destroy();
    tokenChart=new Chart(document.getElementById('tokenChart'),{type:'line',data:{
      labels:sb.map(b=>new Date(b+':00:00Z').toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:true})),
      datasets:s.agents.map(x=>({label:x.agent,data:sb.map(b=>((x.timeSeries||{})[b]||{}).tokens||0),borderColor:C[x.agent],backgroundColor:'transparent',tension:.3,pointRadius:2,borderWidth:2}))
    },options:{responsive:true,interaction:{intersect:false,mode:'index'},plugins:{legend:{labels:{color:'#666',usePointStyle:true,pointStyle:'circle',padding:12,font:{size:11}}}},scales:{x:{ticks:{color:'#444',font:{size:10}},grid:{display:false}},y:{ticks:{color:'#444',callback:v=>fmt(v)},grid:{color:'#1e1e1e'}}}}});

    // Activity
    document.getElementById('feedList').innerHTML=(a.activity||[]).slice(0,15).map(x=>`
      <div class="feed-item">
        <span class="feed-agent" style="color:${C[x.agent]}">${x.agent}</span>
        <span class="feed-badge ${x.role}">${x.role}</span>
        <span class="feed-time">${hm(x.timestamp)}</span>
        <span class="feed-text">${esc(x.content_preview||'')}</span>
      </div>`).join('')||'<div class="empty">No activity yet</div>';

    document.getElementById('lastUpdate').textContent=new Date().toLocaleTimeString();
    renderTeam();
  }catch(e){console.error(e)}
}

function renderTeam(){
  document.getElementById('teamCards').innerHTML=TEAM.map(m=>{
    const s=agentCache[m.k]||{};
    return`<div class="tcard">
      <div class="tcard-top">
        <img class="tcard-photo" src="${m.photo}" onerror="this.src='https://api.dicebear.com/7.x/bottts/svg?seed=${m.name}'">
        <div class="tcard-info"><div class="tname">${m.name}</div><div class="trole">${m.role}</div></div>
      </div>
      <div class="tcard-bio">"${m.bio}"</div>
      <div class="tcard-stats">
        <div class="tcard-stat"><div class="sv">${s.totalMessages||0}</div><div class="sl">Messages</div></div>
        <div class="tcard-stat"><div class="sv">$${$(s.totalCost||0)}</div><div class="sl">Cost</div></div>
        <div class="tcard-stat"><div class="sv">${ago(s.lastActive)}</div><div class="sl">Active</div></div>
      </div>
    </div>`}).join('');
}

// Sprint
async function loadTasks(){
  const r=await fetch('/api/sprints');const d=await r.json();tasks=d.tasks||[];renderTasks();
}
function renderTasks(){
  const cols={backlog:[],'in-progress':[],blocked:[],done:[]};
  tasks.forEach(t=>{if(cols[t.status])cols[t.status].push(t)});
  ['backlog','in-progress','blocked','done'].forEach(s=>{
    document.getElementById('cnt-'+s).textContent=cols[s].length;
    document.getElementById('col-'+s).innerHTML=cols[s].map(t=>`
      <div class="tsk" draggable="true" data-id="${t.id}" style="border-left-color:${C[t.assignee]||'#555'}" ondragstart="ds(event)" ondragend="de(event)">
        <div class="tsk-title">${esc(t.title)}</div>
        ${t.description?`<div class="tsk-desc">${esc(t.description)}</div>`:''}
        <div class="tsk-foot">
          <span class="assignee">${NAMES[t.assignee]||t.assignee}</span>
          <span>${sd(t.created)}</span>
        </div>
        <div class="tsk-actions">
          <button onclick="openComments(${t.id})" title="Comments">üí¨</button>
          <button onclick="openLog(${t.id})" title="Work Log">üìù</button>
          <button onclick="editTask(${t.id})">‚úèÔ∏è</button>
          <button class="del" onclick="delTask(${t.id})">üóëÔ∏è</button>
        </div>
        <div style="display:flex;gap:12px;margin-top:8px;font-size:10px;color:#555;border-top:1px solid #222;padding-top:6px">
          ${(t.comments&&t.comments.length)?`<span>üí¨ ${t.comments.length}</span>`:''}
          ${(t.log&&t.log.length)?`<span>üìù ${t.log.length}</span>`:''}
        </div>
      </div>`).join('')||'<div class="empty" style="padding:24px">Empty</div>';
  });
}
let did=null;
function ds(e){did=e.target.dataset.id;e.target.classList.add('dragging');e.dataTransfer.effectAllowed='move'}
function de(e){e.target.classList.remove('dragging');did=null}
function dragOver(e){e.preventDefault();e.currentTarget.classList.add('drag-over')}
function dragLeave(e){e.currentTarget.classList.remove('drag-over')}
async function drop(e){
  e.preventDefault();e.currentTarget.classList.remove('drag-over');
  if(!did)return;
  await fetch('/api/sprints/'+did,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({status:e.currentTarget.dataset.status})});
  loadTasks();
}
async function openModal(t){
  // Populate goals dropdown
  try{const r=await fetch('/api/goals');const d=await r.json();
  const sel=document.getElementById('mGoalIn');
  sel.innerHTML='<option value="">None</option>'+(d.goals||[]).map(g=>`<option value="${g.id}">${esc(g.title)}</option>`).join('');
  }catch(e){}
  document.getElementById('mTitle').textContent=t?'Edit Task':'New Task';
  document.getElementById('mId').value=t?t.id:'';
  document.getElementById('mTitleIn').value=t?t.title:'';
  document.getElementById('mDescIn').value=t?t.description:'';
  document.getElementById('mAssignIn').value=t?t.assignee:'richard';
  document.getElementById('mStatusIn').value=t?t.status:'backlog';
  document.getElementById('mGoalIn').value=t&&t.goalId?t.goalId:'';
  document.getElementById('modal').classList.add('show');
}
function closeModal(){document.getElementById('modal').classList.remove('show')}
function editTask(id){const t=tasks.find(x=>x.id===id);if(t)openModal(t)}
async function delTask(id){if(!confirm('Delete?'))return;await fetch('/api/sprints/'+id,{method:'DELETE'});loadTasks()}
async function saveTask(){
  const id=document.getElementById('mId').value;
  const goalVal=document.getElementById('mGoalIn').value;
  const b={title:document.getElementById('mTitleIn').value,description:document.getElementById('mDescIn').value,assignee:document.getElementById('mAssignIn').value,status:document.getElementById('mStatusIn').value,goalId:goalVal?parseInt(goalVal):null};
  if(id)await fetch('/api/sprints/'+id,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(b)});
  else await fetch('/api/sprints',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(b)});
  closeModal();loadTasks();
}
document.getElementById('modal').addEventListener('click',e=>{if(e.target===e.currentTarget)closeModal()});

// Comments
function openComments(id){
  const t=tasks.find(x=>x.id===id);
  if(!t)return;
  document.getElementById('commentTaskId').value=id;
  document.getElementById('commentTitle').textContent='üí¨ '+t.title;
  document.getElementById('commentAssignee').textContent='Assigned: '+(NAMES[t.assignee]||t.assignee);
  document.getElementById('commentInput').value='';
  renderComments(t.comments||[]);
  document.getElementById('commentModal').classList.add('show');
  setTimeout(()=>document.getElementById('commentInput').focus(),100);
}
function closeComments(){document.getElementById('commentModal').classList.remove('show')}
function renderComments(comments){
  if(!comments.length){document.getElementById('commentList').innerHTML='<div style="padding:20px;text-align:center;color:#555;font-size:13px">No comments yet ‚Äî leave one below</div>';return}
  document.getElementById('commentList').innerHTML=comments.map(c=>{
    const isAgent=['richard','erlich','dinesh','gilfoyle','jiangyang'].includes((c.author||'').toLowerCase());
    const color=isAgent?C[(c.author||'').toLowerCase()]||'#888':'#10b981';
    const label=isAgent?(NAMES[(c.author||'').toLowerCase()]||c.author):c.author;
    const ts=c.timestamp?new Date(c.timestamp).toLocaleString('en-US',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit',hour12:true}):'';
    return`<div style="padding:12px 0;border-bottom:1px solid #222">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
        <span style="font-size:12px;font-weight:600;color:${color}">${esc(label)}</span>
        <span style="font-size:10px;color:#444">${ts}</span>
      </div>
      <div style="font-size:13px;color:#ccc;line-height:1.5;padding-left:0">${esc(c.text)}</div>
    </div>`}).join('');
  // Scroll to bottom
  const el=document.getElementById('commentList');
  el.scrollTop=el.scrollHeight;
}
async function addComment(){
  const id=document.getElementById('commentTaskId').value;
  const input=document.getElementById('commentInput');
  const text=input.value.trim();
  if(!text||!id)return;
  const r=await fetch('/api/sprints/'+id+'/comments',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text,author:'You'})});
  const d=await r.json();
  if(d.ok){
    input.value='';
    renderComments(d.comments);
    const t=tasks.find(x=>x.id==id);
    if(t)t.comments=d.comments;
    renderTasks();
  }
}
document.getElementById('commentModal').addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();addComment()}});

// Work Log
function openLog(id){
  const t=tasks.find(x=>x.id===id);
  if(!t)return;
  document.getElementById('logTaskId').value=id;
  document.getElementById('logTitle').textContent='üìù '+t.title;
  document.getElementById('logInput').value='';
  renderLogEntries(t.log||[]);
  document.getElementById('logModal').classList.add('show');
  setTimeout(()=>document.getElementById('logInput').focus(),100);
}
function closeLog(){document.getElementById('logModal').classList.remove('show')}
function renderLogEntries(log){
  if(!log.length){document.getElementById('logEntries').innerHTML='<div style="padding:16px;text-align:center;color:#555;font-size:13px">No entries yet</div>';return}
  document.getElementById('logEntries').innerHTML=log.map((e,i)=>`
    <div style="display:flex;align-items:flex-start;gap:10px;padding:8px 0;border-bottom:1px solid #222;font-size:13px">
      <span style="color:#444;min-width:20px;text-align:right;font-size:11px;padding-top:2px">${i+1}.</span>
      <span style="color:#ccc;line-height:1.5">${esc(e)}</span>
    </div>`).join('');
}
async function addLogEntry(){
  const id=document.getElementById('logTaskId').value;
  const input=document.getElementById('logInput');
  const entry=input.value.trim();
  if(!entry||!id)return;
  const r=await fetch('/api/sprints/'+id+'/log',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({entry})});
  const d=await r.json();
  if(d.ok){
    input.value='';
    renderLogEntries(d.log);
    // Update local task data
    const t=tasks.find(x=>x.id==id);
    if(t)t.log=d.log;
    renderTasks();
  }
}
document.addEventListener('keydown',e=>{if(e.key==='Enter'&&document.getElementById('logModal').classList.contains('show'))addLogEntry()});

// Drive
let dFiles=[];
const fi=n=>{const e=(n.split('.').pop()||'').toLowerCase();const m={pdf:'üìï',doc:'üìò',docx:'üìò',txt:'üìÑ',md:'üìù',ppt:'üìô',pptx:'üìô',xls:'üìó',xlsx:'üìó',csv:'üìó',js:'üíõ',py:'üêç',html:'üåê',css:'üé®',json:'üìã',png:'üñºÔ∏è',jpg:'üñºÔ∏è',jpeg:'üñºÔ∏è',gif:'üñºÔ∏è',svg:'üñºÔ∏è',zip:'üì¶',mp4:'üé¨',mp3:'üéµ'};return m[e]||'üìÑ'};
async function loadFiles(){
  const r=await fetch('/api/files');const d=await r.json();dFiles=d.files||[];renderFiles(dFiles);
}
function renderFiles(f){
  document.getElementById('dCount').textContent=f.length;
  document.getElementById('dSize').textContent=fb(f.reduce((s,x)=>s+x.size,0));
  document.getElementById('dLast').textContent=f.length?ago(f[0].uploaded):'‚Äî';
  if(!f.length){document.getElementById('dBody').innerHTML='<tr><td colspan="4"><div class="empty"><div class="eicon">üìÇ</div>No files yet</div></td></tr>';return}
  document.getElementById('dBody').innerHTML=f.map(x=>`
    <tr style="cursor:pointer" onclick="openViewer('${esc(x.name).replace(/'/g,"\\'")}',${x.size})">
      <td><span class="fname">${fi(x.name)} ${esc(x.name)}</span></td>
      <td class="fmeta">${fb(x.size)}</td>
      <td class="fmeta">${ago(x.uploaded)}</td>
      <td class="factions" onclick="event.stopPropagation()">
        <a href="/api/files/${encodeURIComponent(x.name)}" class="btn btn-o" style="font-size:11px;padding:5px 12px;text-decoration:none">Download</a>
        <button onclick="delFile('${esc(x.name)}')" class="btn btn-r" style="font-size:11px;padding:5px 12px;margin-left:4px">Delete</button>
      </td>
    </tr>`).join('');
}
function filterFiles(){const q=document.getElementById('driveQ').value.toLowerCase();renderFiles(dFiles.filter(f=>f.name.toLowerCase().includes(q)))}
async function uploadFiles(){
  const i=document.getElementById('driveInput');if(!i.files.length)return;
  const fd=new FormData();for(const f of i.files)fd.append('file',f);
  await fetch('/api/files/upload',{method:'POST',body:fd});i.value='';loadFiles();
}
async function delFile(n){if(!confirm('Delete '+n+'?'))return;await fetch('/api/files/'+encodeURIComponent(n),{method:'DELETE'});loadFiles()}

// File Viewer
function openViewer(name,size){
  const ext=(name.split('.').pop()||'').toLowerCase();
  const url='/api/files/'+encodeURIComponent(name)+'?preview=1';
  document.getElementById('vIcon').textContent=fi(name);
  document.getElementById('vName').textContent=name;
  document.getElementById('vSize').textContent=fb(size);
  document.getElementById('vDownload').href='/api/files/'+encodeURIComponent(name);
  const c=document.getElementById('vContent');

  // Images
  if(['png','jpg','jpeg','gif','svg','webp','bmp','ico'].includes(ext)){
    c.innerHTML=`<img src="${url}" style="max-width:100%;max-height:100%;object-fit:contain">`;
  }
  // PDF
  else if(ext==='pdf'){
    c.innerHTML=`<iframe src="${url}" style="width:100%;height:100%;border:none"></iframe>`;
  }
  // Video
  else if(['mp4','webm','ogg','mov'].includes(ext)){
    c.innerHTML=`<video controls autoplay style="max-width:100%;max-height:100%"><source src="${url}">Your browser does not support video.</video>`;
  }
  // Audio
  else if(['mp3','wav','ogg','flac','aac','m4a'].includes(ext)){
    c.innerHTML=`<div style="text-align:center;padding:40px"><div style="font-size:64px;margin-bottom:24px">üéµ</div><div style="color:#fff;font-size:16px;margin-bottom:20px">${esc(name)}</div><audio controls autoplay style="width:100%;max-width:500px"><source src="${url}">Your browser does not support audio.</audio></div>`;
  }
  // Text / Code
  else if(['txt','md','json','js','py','html','css','csv','xml','yml','yaml','toml','ini','cfg','conf','log','sh','bash','zsh','sql','java','cpp','c','h','go','rs','ts','tsx','jsx','rb','php','swift','kt','r','env','gitignore','dockerfile','makefile'].includes(ext)){
    c.innerHTML='<div style="padding:24px;color:#888;font-size:13px">Loading...</div>';
    fetch(url).then(r=>r.text()).then(text=>{
      const lang=['json','js','py','html','css','xml','sql','java','cpp','c','go','rs','ts','tsx','jsx','rb','php','swift','sh','bash','yml','yaml'].includes(ext)?ext:'plaintext';
      c.innerHTML=`<pre style="width:100%;height:100%;margin:0;padding:24px;overflow:auto;background:#111;color:#ccc;font-family:'SF Mono',Monaco,Consolas,monospace;font-size:13px;line-height:1.6;white-space:pre-wrap;word-break:break-word;text-align:left">${esc(text)}</pre>`;
    });
  }
  // Markdown rendered
  else if(ext==='md'){
    c.innerHTML='<div style="padding:24px;color:#888">Loading...</div>';
    fetch(url).then(r=>r.text()).then(text=>{
      c.innerHTML=`<div style="width:100%;height:100%;padding:32px;overflow:auto;color:#ccc;font-size:14px;line-height:1.7;text-align:left"><pre style="white-space:pre-wrap;font-family:inherit">${esc(text)}</pre></div>`;
    });
  }
  // Office docs ‚Äî use Google Docs Viewer
  else if(['doc','docx','xls','xlsx','ppt','pptx'].includes(ext)){
    c.innerHTML=`<div style="text-align:center;padding:40px;color:#888"><div style="font-size:48px;margin-bottom:16px">${fi(name)}</div><p style="margin-bottom:16px">Office document preview requires a public URL.</p><a href="/api/files/${encodeURIComponent(name)}" class="btn btn-w" style="text-decoration:none">Download to view</a></div>`;
  }
  // Fallback
  else{
    c.innerHTML=`<div style="text-align:center;padding:40px;color:#888"><div style="font-size:48px;margin-bottom:16px">${fi(name)}</div><p style="margin-bottom:16px">Preview not available for .${esc(ext)} files</p><a href="/api/files/${encodeURIComponent(name)}" class="btn btn-w" style="text-decoration:none">Download</a></div>`;
  }

  document.getElementById('viewer').classList.add('show');
}
function closeViewer(){document.getElementById('viewer').classList.remove('show');document.getElementById('vContent').innerHTML=''}
document.addEventListener('keydown',e=>{if(e.key==='Escape'){closeViewer();closeModal()}})

// Goals
async function loadGoals(){
  const r=await fetch('/api/goals');const d=await r.json();
  const goals=d.goals||[];
  if(!goals.length){document.getElementById('goalsList').innerHTML='<div class="empty" style="padding:40px">No goals yet ‚Äî create one above</div>';return}
  document.getElementById('goalsList').innerHTML=goals.map(g=>{
    const pct=g.progress||0;
    const color=pct>=100?'#10b981':pct>=50?'#38bdf8':'#a78bfa';
    const daysLeft=g.deadline?Math.ceil((new Date(g.deadline)-Date.now())/(1000*60*60*24)):null;
    const deadlineColor=daysLeft!==null?(daysLeft<0?'#ef4444':daysLeft<7?'#fb923c':'#555'):'#555';
    const statusIcon=g.status==='completed'?'‚úÖ':g.status==='paused'?'‚è∏Ô∏è':'üéØ';
    return`<div style="background:#1a1a1a;border:1px solid #222;border-radius:12px;padding:24px;margin-bottom:16px;transition:border-color .15s" onmouseover="this.style.borderColor='#333'" onmouseout="this.style.borderColor='#222'">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px">
        <div>
          <div style="font-size:16px;font-weight:700;color:#fff;margin-bottom:4px">${statusIcon} ${esc(g.title)}</div>
          <div style="font-size:12px;color:#666">${esc(g.description||'')}</div>
        </div>
        <div style="display:flex;gap:6px;flex-shrink:0">
          <button class="btn btn-o" style="font-size:11px;padding:4px 10px" onclick="editGoal(${g.id})">Edit</button>
          <button class="btn btn-r" style="font-size:11px;padding:4px 10px" onclick="delGoal(${g.id})">Delete</button>
        </div>
      </div>
      <div style="display:flex;gap:24px;align-items:center;margin-bottom:14px;font-size:12px">
        <span style="color:${C[g.owner]||'#888'}">Owner: <strong>${NAMES[g.owner]||g.owner}</strong></span>
        ${g.deadline?`<span style="color:${deadlineColor}">Deadline: <strong>${g.deadline}</strong>${daysLeft!==null?' ('+(daysLeft<0?Math.abs(daysLeft)+'d overdue':daysLeft+'d left')+')':''}</span>`:''}
        <span style="color:#555">Tasks: <strong>${g.completedTasks||0}/${g.linkedTasks||0}</strong></span>
      </div>
      <div style="background:#222;border-radius:6px;height:10px;overflow:hidden;position:relative">
        <div style="background:${color};height:100%;width:${pct}%;border-radius:6px;transition:width .5s"></div>
      </div>
      <div style="display:flex;justify-content:space-between;margin-top:6px;font-size:11px">
        <span style="color:#555">${pct}% complete</span>
        <span style="color:${color};font-weight:600">${pct>=100?'üéâ Done!':pct>=50?'On track':'Getting started'}</span>
      </div>
    </div>`}).join('');
}
function openGoalModal(g){
  document.getElementById('goalModalTitle').textContent=g?'Edit Goal':'New Goal';
  document.getElementById('goalId').value=g?g.id:'';
  document.getElementById('goalTitleIn').value=g?g.title:'';
  document.getElementById('goalDescIn').value=g?g.description:'';
  document.getElementById('goalOwnerIn').value=g?g.owner:'richard';
  document.getElementById('goalDeadlineIn').value=g?g.deadline:'';
  document.getElementById('goalModal').classList.add('show');
}
function closeGoalModal(){document.getElementById('goalModal').classList.remove('show')}
let goalsCache=[];
async function editGoal(id){
  if(!goalsCache.length){const r=await fetch('/api/goals');const d=await r.json();goalsCache=d.goals||[]}
  const g=goalsCache.find(x=>x.id===id);if(g)openGoalModal(g);
}
async function saveGoal(){
  const id=document.getElementById('goalId').value;
  const b={title:document.getElementById('goalTitleIn').value,description:document.getElementById('goalDescIn').value,owner:document.getElementById('goalOwnerIn').value,deadline:document.getElementById('goalDeadlineIn').value};
  if(id)await fetch('/api/goals/'+id,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(b)});
  else await fetch('/api/goals',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(b)});
  closeGoalModal();loadGoals();
}
async function delGoal(id){if(!confirm('Delete this goal?'))return;await fetch('/api/goals/'+id,{method:'DELETE'});loadGoals()}

// Leaderboard
async function loadLeaderboard(){
  const r=await fetch('/api/leaderboard');const d=await r.json();
  const lb=d.leaderboard||[];
  const statusColors={shipping:'#10b981',grinding:'#38bdf8',blocked:'#ef4444',idle:'#555'};
  const statusEmoji={shipping:'üöÄ',grinding:'‚ö°',blocked:'üî¥',idle:'üí§'};
  document.getElementById('lbContent').innerHTML=`
    <div style="display:grid;gap:12px">
      ${lb.map((a,i)=>{
        const barMax=Math.max(...lb.map(x=>x.score),1);
        const barPct=Math.round(a.score/barMax*100);
        return`<div style="background:#1a1a1a;border:1px solid #222;border-radius:12px;padding:20px;display:flex;align-items:center;gap:20px;transition:border-color .15s${i===0?';border-color:#333;background:#1c1c1c':''}" onmouseover="this.style.borderColor='#444'" onmouseout="this.style.borderColor='${i===0?'#333':'#222'}'">
          <div style="font-size:28px;width:40px;text-align:center;flex-shrink:0">${a.badge||'#'+(i+1)}</div>
          <div style="flex:1;min-width:0">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
              <span style="font-size:16px;font-weight:700;color:${C[a.agent]||'#fff'};text-transform:capitalize">${a.agent}</span>
              <span style="font-size:11px;padding:3px 10px;border-radius:12px;background:${statusColors[a.status]||'#333'}22;color:${statusColors[a.status]||'#888'};font-weight:600">${statusEmoji[a.status]||''} ${a.status}</span>
              <span style="font-size:24px;font-weight:800;color:#fff;margin-left:auto">${a.score}</span>
              <span style="font-size:10px;color:#555;text-transform:uppercase">pts</span>
            </div>
            <div style="background:#222;border-radius:4px;height:6px;overflow:hidden;margin-bottom:10px">
              <div style="background:${C[a.agent]||'#38bdf8'};height:100%;width:${barPct}%;border-radius:4px;transition:width .5s"></div>
            </div>
            <div style="display:flex;gap:16px;font-size:11px;color:#555;flex-wrap:wrap">
              <span>‚úÖ <strong style="color:#10b981">${a.done}</strong> done</span>
              <span>üî® <strong style="color:#38bdf8">${a.inProgress}</strong> in progress</span>
              <span>üî¥ <strong style="color:#ef4444">${a.blocked}</strong> blocked</span>
              <span>üìã <strong style="color:#888">${a.backlog}</strong> backlog</span>
              <span>üìù <strong style="color:#a78bfa">${a.logEntries}</strong> logs</span>
              <span>‚è±Ô∏è <strong style="color:#38bdf8">${a.activeHours}h</strong> active</span>
              <span>üßë‚Äçüíª <strong style="color:#a78bfa">${a.humanEquivHours}h</strong> saved</span>
            </div>
          </div>
        </div>`}).join('')}
    </div>
    <div style="margin-top:24px;background:#1a1a1a;border:1px solid #222;border-radius:12px;padding:20px">
      <div style="font-size:12px;font-weight:600;color:#555;text-transform:uppercase;letter-spacing:.06em;margin-bottom:12px">Scoring</div>
      <div style="font-size:12px;color:#666;line-height:1.8">
        ‚úÖ Task completed = <strong style="color:#10b981">+10 pts</strong> ¬∑ 
        üî® In progress = <strong style="color:#38bdf8">+3 pts</strong> ¬∑ 
        üìù Log entry = <strong style="color:#a78bfa">+2 pts</strong> ¬∑ 
        üí¨ Comment = <strong style="color:#888">+1 pt</strong> ¬∑ 
        üî¥ Blocked = <strong style="color:#ef4444">-5 pts</strong>
      </div>
    </div>`;
}

// Messages
let allMsgs=[];
async function loadMsgs(){
  const agent=document.getElementById('msgAgent').value;
  const role=document.getElementById('msgRole').value;
  let url='/api/messages?limit=200';
  if(agent)url+='&agent='+agent;
  if(role)url+='&role='+role;
  const r=await fetch(url);const d=await r.json();
  allMsgs=d.messages||[];
  renderMsgs(allMsgs);
}
function filterMsgs(){
  const q=document.getElementById('msgSearch').value.toLowerCase();
  renderMsgs(allMsgs.filter(m=>(m.content_preview||'').toLowerCase().includes(q)||(m.agent||'').includes(q)));
}
function renderMsgs(msgs){
  if(!msgs.length){document.getElementById('msgList').innerHTML='<div class="empty" style="padding:40px">No messages found</div>';return}
  document.getElementById('msgList').innerHTML=msgs.map(m=>{
    const isUser=m.role==='user';
    return`<div style="display:flex;gap:12px;padding:12px 20px;border-bottom:1px solid #1e1e1e;align-items:flex-start;transition:background .1s"
      onmouseover="this.style.background='#1e1e1e'" onmouseout="this.style.background=''">
      <div style="min-width:80px">
        <span style="font-size:12px;font-weight:600;color:${C[m.agent]||'#888'};text-transform:capitalize">${m.agent}</span>
      </div>
      <div style="min-width:70px">
        <span class="feed-badge ${m.role}" style="font-size:10px;padding:2px 8px;border-radius:4px;font-weight:600">${isUser?'IN':'OUT'}</span>
      </div>
      <div style="min-width:130px;font-size:11px;color:#444;font-variant-numeric:tabular-nums;padding-top:1px">
        ${m.timestamp?new Date(m.timestamp).toLocaleString('en-US',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit',hour12:true}):''}
      </div>
      <div style="flex:1;min-width:0;font-size:12px;color:${isUser?'#888':'#ccc'};line-height:1.5;word-break:break-word">
        ${esc(m.content_preview||'')}
      </div>
    </div>`}).join('');
}

// Code / Repos
let allRepos=[];
const langColors={'TypeScript':'#3178c6','JavaScript':'#f1e05a','Python':'#3572a5','HTML':'#e34c26','CSS':'#563d7c','Shell':'#89e051','Java':'#b07219','Vue':'#41b883','Jupyter Notebook':'#DA5B0B','Go':'#00ADD8','Rust':'#dea584','Ruby':'#701516'};

async function loadRepos(){
  try{
    const r=await fetch('/api/repos');const d=await r.json();allRepos=d.repos||[];
    // Populate language filter
    const langs=new Set(allRepos.map(r=>(r.primaryLanguage||{}).name).filter(Boolean));
    const sel=document.getElementById('codeLang');
    const current=sel.value;
    sel.innerHTML='<option value="">All Languages</option>'+[...langs].sort().map(l=>`<option value="${l}">${l}</option>`).join('');
    sel.value=current;
    filterRepos();
  }catch(e){console.error(e)}
}
function filterRepos(){
  const q=(document.getElementById('codeSearch').value||'').toLowerCase();
  const lang=document.getElementById('codeLang').value;
  let f=allRepos;
  if(q)f=f.filter(r=>r.name.toLowerCase().includes(q)||(r.description||'').toLowerCase().includes(q));
  if(lang)f=f.filter(r=>(r.primaryLanguage||{}).name===lang);
  renderRepos(f);
}
function renderRepos(repos){
  const langs=new Set(allRepos.map(r=>(r.primaryLanguage||{}).name).filter(Boolean));
  document.getElementById('repoCount').textContent=allRepos.length;
  document.getElementById('repoLangs').textContent=langs.size;
  const latest=allRepos.length?allRepos.reduce((a,b)=>a.updatedAt>b.updatedAt?a:b).updatedAt:null;
  document.getElementById('repoLastPush').textContent=latest?ago(latest):'‚Äî';

  if(!repos.length){document.getElementById('repoGrid').innerHTML='<div class="empty" style="padding:48px;grid-column:1/-1"><div class="eicon">üíª</div>No repos found</div>';return}

  document.getElementById('repoGrid').innerHTML=repos.map(r=>{
    const lang=(r.primaryLanguage||{}).name||'';
    const lc=langColors[lang]||'#888';
    const isActive=r.updatedAt&&(Date.now()-new Date(r.updatedAt))<7*24*60*60*1000;
    return`<div style="background:#1a1a1a;border:1px solid #222;border-radius:12px;padding:20px;transition:border-color .15s;cursor:pointer" onmouseover="this.style.borderColor='#333'" onmouseout="this.style.borderColor='#222'" onclick="viewCommits('${esc(r.name)}')">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px">
        <div style="min-width:0">
          <div style="font-size:15px;font-weight:600;color:#fff;display:flex;align-items:center;gap:8px">
            <span style="color:#888">üì¶</span>${esc(r.name)}
            ${r.isPrivate?'<span style="font-size:9px;padding:2px 6px;border-radius:4px;background:#332200;color:#f59e0b;font-weight:600">PRIVATE</span>':''}
            ${isActive?'<span style="width:6px;height:6px;border-radius:50%;background:#10b981;flex-shrink:0" title="Active this week"></span>':''}
          </div>
          ${r.description?`<div style="font-size:12px;color:#666;margin-top:4px;line-height:1.5">${esc(r.description)}</div>`:''}
        </div>
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center;font-size:11px;color:#444;margin-top:12px">
        <div style="display:flex;gap:12px;align-items:center">
          ${lang?`<span style="display:flex;align-items:center;gap:4px"><span style="width:8px;height:8px;border-radius:50%;background:${lc}"></span><span style="color:#888">${lang}</span></span>`:''}
          ${r.stargazerCount?`<span>‚≠ê ${r.stargazerCount}</span>`:''}
          ${r.forkCount?`<span>üç¥ ${r.forkCount}</span>`:''}
        </div>
        <span>Updated ${ago(r.updatedAt)}</span>
      </div>
      <div style="display:flex;gap:6px;margin-top:12px" onclick="event.stopPropagation()">
        <a href="${r.url}" target="_blank" class="btn btn-o" style="font-size:11px;padding:5px 12px;text-decoration:none">GitHub ‚Üó</a>
        <button class="btn btn-o" style="font-size:11px;padding:5px 12px" onclick="viewCommits('${esc(r.name)}')">Commits</button>
      </div>
    </div>`}).join('');
}

async function viewCommits(name){
  document.getElementById('commitTitle').textContent='üìù '+name+' ‚Äî Recent Commits';
  document.getElementById('commitList').innerHTML='<div style="padding:20px;text-align:center;color:#555">Loading commits...</div>';
  document.getElementById('commitModal').classList.add('show');
  try{
    const r=await fetch('/api/repos/'+encodeURIComponent(name)+'/commits');
    const d=await r.json();
    const commits=d.commits||[];
    if(!commits.length){
      document.getElementById('commitList').innerHTML='<div style="padding:20px;text-align:center;color:#555">No commits found</div>';
      return;
    }
    document.getElementById('commitList').innerHTML=commits.map(c=>`
      <div style="padding:12px 0;border-bottom:1px solid #222">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px">
          <div style="min-width:0;flex:1">
            <div style="font-size:13px;color:#fff;font-weight:500;line-height:1.5;word-break:break-word">${esc((c.message||'').split('\\n')[0])}</div>
            <div style="font-size:11px;color:#555;margin-top:4px">
              <span style="color:#888">${esc(c.author||'')}</span> ¬∑ ${c.date?ago(c.date):''}
            </div>
          </div>
          <code style="font-size:11px;background:#222;padding:3px 8px;border-radius:4px;color:#10b981;white-space:nowrap">${c.sha||''}</code>
        </div>
      </div>`).join('');
  }catch(e){
    document.getElementById('commitList').innerHTML='<div style="padding:20px;text-align:center;color:#ef4444">Error loading commits</div>';
  }
}
function closeCommits(){document.getElementById('commitModal').classList.remove('show')}

// Docs
let allDocs=[];
const catIcons={onboarding:'üöÄ',tutorial:'üìö',runbook:'üîß',architecture:'üèóÔ∏è',process:'üìã',general:'üìÑ'};
const audienceLabels={human:'üßë Human',ai:'ü§ñ AI Agent',all:'üë• Everyone'};

async function loadDocs(){
  const r=await fetch('/api/docs');const d=await r.json();allDocs=d.docs||[];filterDocs();
}
function filterDocs(){
  const cat=document.getElementById('docCatFilter').value;
  const aud=document.getElementById('docAudienceFilter').value;
  const q=(document.getElementById('docSearch').value||'').toLowerCase();
  let f=allDocs;
  if(cat)f=f.filter(d=>d.category===cat);
  if(aud)f=f.filter(d=>d.audience===aud);
  if(q)f=f.filter(d=>(d.title||'').toLowerCase().includes(q)||(d.content||'').toLowerCase().includes(q)||(d.tags||[]).some(t=>t.toLowerCase().includes(q)));
  renderDocs(f);
}
function renderDocs(docs){
  const cats=new Set(allDocs.map(d=>d.category));
  document.getElementById('docCount').textContent=allDocs.length;
  document.getElementById('docCats').textContent=cats.size;
  const lastUp=allDocs.length?allDocs.reduce((a,b)=>a.updated>b.updated?a:b).updated:null;
  document.getElementById('docLastUpdate').textContent=lastUp?ago(lastUp):'‚Äî';

  if(!docs.length){document.getElementById('docsGrid').innerHTML='<div class="empty" style="padding:48px;grid-column:1/-1"><div class="eicon">üìñ</div>No docs yet ‚Äî create one to get started</div>';return}
  document.getElementById('docsGrid').innerHTML=docs.map(d=>{
    const preview=(d.content||'').substring(0,150).replace(/[#*`\[\]]/g,'');
    return`<div style="background:#1a1a1a;border:1px solid #222;border-radius:12px;padding:20px;cursor:pointer;transition:border-color .15s" onmouseover="this.style.borderColor='#333'" onmouseout="this.style.borderColor='#222'" onclick="viewDoc(${d.id})">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px">
        <div style="font-size:15px;font-weight:600;color:#fff;display:flex;align-items:center;gap:8px">
          <span>${catIcons[d.category]||'üìÑ'}</span>${esc(d.title)}
        </div>
        <span style="font-size:10px;padding:3px 8px;border-radius:12px;background:#222;color:#888;white-space:nowrap">${audienceLabels[d.audience]||d.audience}</span>
      </div>
      <div style="font-size:12px;color:#666;line-height:1.6;margin-bottom:12px;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden">${esc(preview)}${preview.length>=150?'...':''}</div>
      <div style="display:flex;justify-content:space-between;align-items:center;font-size:11px;color:#444">
        <span style="color:${C[d.author]||'#888'};font-weight:500;text-transform:capitalize">${d.author}</span>
        <span>${ago(d.updated)}</span>
      </div>
      ${(d.tags&&d.tags.length)?`<div style="display:flex;gap:4px;flex-wrap:wrap;margin-top:8px">${d.tags.map(t=>`<span style="font-size:10px;padding:2px 8px;border-radius:4px;background:#222;color:#666">${esc(t)}</span>`).join('')}</div>`:''}
      <div style="display:flex;gap:4px;margin-top:10px;justify-content:flex-end" onclick="event.stopPropagation()">
        <button class="btn btn-o" style="font-size:11px;padding:4px 10px" onclick="editDoc(${d.id})">‚úèÔ∏è</button>
        <button class="btn btn-r" style="font-size:11px;padding:4px 10px" onclick="delDoc(${d.id})">üóëÔ∏è</button>
      </div>
    </div>`}).join('');
}

function openDocModal(d){
  document.getElementById('docModalTitle').textContent=d?'Edit Doc':'New Doc';
  document.getElementById('docId').value=d?d.id:'';
  document.getElementById('docTitleIn').value=d?d.title:'';
  document.getElementById('docCategoryIn').value=d?d.category:'onboarding';
  document.getElementById('docAudienceIn').value=d?d.audience:'all';
  document.getElementById('docAuthorIn').value=d?d.author:'richard';
  document.getElementById('docTagsIn').value=d?(d.tags||[]).join(', '):'';
  document.getElementById('docContentIn').value=d?d.content:'';
  document.getElementById('docModal').classList.add('show');
}
function closeDocModal(){document.getElementById('docModal').classList.remove('show')}

async function saveDoc(){
  const id=document.getElementById('docId').value;
  const tags=document.getElementById('docTagsIn').value.split(',').map(t=>t.trim()).filter(Boolean);
  const b={
    title:document.getElementById('docTitleIn').value,
    category:document.getElementById('docCategoryIn').value,
    audience:document.getElementById('docAudienceIn').value,
    author:document.getElementById('docAuthorIn').value,
    tags:tags,
    content:document.getElementById('docContentIn').value
  };
  if(id)await fetch('/api/docs/'+id,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(b)});
  else await fetch('/api/docs',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(b)});
  closeDocModal();loadDocs();
}

async function editDoc(id){
  const r=await fetch('/api/docs/'+id);const d=await r.json();
  openDocModal(d);
}
async function delDoc(id){if(!confirm('Delete this doc?'))return;await fetch('/api/docs/'+id,{method:'DELETE'});loadDocs()}

let currentViewDocId=null;
async function viewDoc(id){
  const r=await fetch('/api/docs/'+id);const d=await r.json();
  currentViewDocId=id;
  document.getElementById('dvTitle').textContent=d.title;
  document.getElementById('dvMeta').innerHTML=`${catIcons[d.category]||''} ${d.category} ¬∑ ${audienceLabels[d.audience]||d.audience} ¬∑ by <span style="color:${C[d.author]||'#888'}">${NAMES[d.author]||d.author}</span> ¬∑ updated ${ago(d.updated)}`;
  // Simple markdown rendering
  let html=esc(d.content||'')
    .replace(/^### (.+)$/gm,'<h3 style="font-size:16px;font-weight:700;color:#fff;margin:20px 0 8px">$1</h3>')
    .replace(/^## (.+)$/gm,'<h2 style="font-size:18px;font-weight:700;color:#fff;margin:24px 0 10px">$1</h2>')
    .replace(/^# (.+)$/gm,'<h1 style="font-size:22px;font-weight:700;color:#fff;margin:28px 0 12px">$1</h1>')
    .replace(/\*\*(.+?)\*\*/g,'<strong style="color:#fff">$1</strong>')
    .replace(/`([^`]+)`/g,'<code style="background:#222;padding:2px 6px;border-radius:4px;font-size:12px;color:#10b981">$1</code>')
    .replace(/^- (.+)$/gm,'<li style="margin-left:16px;margin-bottom:4px">$1</li>')
    .replace(/^(\d+)\. (.+)$/gm,'<li style="margin-left:16px;margin-bottom:4px;list-style:decimal">$2</li>')
    .replace(/\n\n/g,'<br><br>')
    .replace(/\n/g,'<br>');
  document.getElementById('dvContent').innerHTML=html;
  document.getElementById('docViewer').classList.add('show');
}
function closeDocViewer(){document.getElementById('docViewer').classList.remove('show');currentViewDocId=null}
function editDocFromViewer(){if(currentViewDocId){closeDocViewer();editDoc(currentViewDocId)}}

refresh();
setInterval(refresh,30000);
</script>
</body>
</html>
